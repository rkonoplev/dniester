# Руководство по конфигурации

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Содержание
- [Расположение файлов конфигурации](#расположение-файлов-конфигурации)
- [Конфигурация для тестов](#конфигурация-для-тестов)
- [Матрица профилей Spring](#матрица-профилей-spring)
- [Запуск с профилями](#запуск-с-профилями)
- [Переменные окружения и .env](#переменные-окружения-и-env)
- [Управление секретами](#управление-секретами)
- [Лучшие практики](#лучшие-практики)


Этот документ объясняет стратегию конфигурации для бэкенда Phoebe CMS.  
Профили Spring Boot, файлы конфигурации YAML и переменные окружения используются для обеспечения безопасности,
портативности и консистентности системы в различных средах.

---

## Расположение файлов конфигурации

Конфигурация приложения разделена между двумя основными директориями:

1.  **`backend/src/main/resources/`**
    - Содержит конфигурацию для запуска основного приложения, а также основной файл конфигурации для тестов.
    - `application.yml` — базовый файл.
    - `application-<profile>.yml` — файлы для конкретных сред.

2.  **`backend/src/test/resources/`**
    - Может содержать файлы для переопределения конфигурации из `main/resources` специально для тестов.
    - Настройки из этой директории имеют **более высокий приоритет** во время тестового запуска.

---

## Конфигурация для тестов

- **`application-integration-test.yml` (Актуальный профиль)**
  - **Статус**: **Единственный используемый профиль для всех тестов.**
  - **Расположение**: `src/main/resources/`
  - **Описание**: Используется для всех интеграционных тестов (`@SpringBootTest`). Активируется через `@ActiveProfiles("integration-test")`. Настроен на использование **Testcontainers** с MySQL. Flyway в этом профиле отключен (`spring.flyway.enabled: false`), а схема управляется Hibernate (`ddl-auto: create-drop`).

- **`application-test.yml` (Устаревший профиль)**
  - **Статус**: **Устарел, не используется.**
  - **Расположение**: `src/test/resources/`
  - **Описание**: Ранее использовался по умолчанию для тестов и был настроен на встраиваемую базу данных H2. После полного перехода на Testcontainers этот профиль больше не является частью основного процесса тестирования.

---

## Матрица профилей Spring

| Профиль            | Статус                               | Расположение файла | База данных        | Использование                                                               |
|:-------------------|:-------------------------------------|:-------------------|:-------------------|:----------------------------------------------------------------------------|
| `local`            | **Актуальный**                       | `main/resources`   | MySQL (Docker)     | Локальная разработка через `make run`.                                      |
| `integration-test` | **Актуальный (для тестов)**          | `main/resources`   | MySQL (Testcontainers) | Все тесты (`make test`). Testcontainers управляет БД.                       |
| `prod`             | **Актуальный**                       | `main/resources`   | Внешняя БД         | Продакшен-сборка.                                                           |
| `test`             | **Устарел**                          | `test/resources`   | H2 (в памяти)      | Ранее использовался для тестов с H2. **Больше не используется.**            |
| `dev` / `ci`       | **Устарел**                          | -                  | -                  | Ранее использовались в CI/CD. **Больше не используются.**                   |
| `mysql` / `postgresql` | Вспомогательный                  | `main/resources`   | -                  | Указывают путь к специфичным для БД миграциям Flyway.                      |
| `security`         | Актуальный (включается автоматически)| `main/resources`   | -                  | Централизует настройки безопасности.                                        |

---

## Запуск с профилями

**Актуальные способы:**
```bash
# Запуск для локальной разработки (активирует профиль 'local')
make run

# Запуск всех тестов (активирует профиль 'integration-test')
make all-tests
```

**Устаревшие примеры (для исторического контекста):**
```bash
# (Устаревший пример) Запуск с комбинированным профилем dev и mysql
SPRING_PROFILES_ACTIVE=dev,mysql ./gradlew bootRun

# (Устаревший пример) Запуск тестов с профилем CI
SPRING_PROFILES_ACTIVE=ci ./gradlew test
```

---

## Переменные окружения и .env

Файл `.env` (игнорируется git) предоставляет учетные данные для БД и приложения локально при использовании `make run`.

Пример `.env`:
```
# Учетные данные MySQL
MYSQL_ROOT_PASSWORD=root
MYSQL_DATABASE=phoebe_db
MYSQL_USER=root
MYSQL_PASSWORD=root

# Порты
SPRING_LOCAL_PORT=8080
DATABASE_LOCAL_PORT=3306

# Источник данных Spring
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:${DATABASE_LOCAL_PORT}/${MYSQL_DATABASE}
SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}

# Учетные данные для аутентификации (Basic Auth)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
```

---

## Управление секретами

### Безопасность аутентификации
- **Текущая реализация**: Basic Auth с учетными данными пользователей из базы данных.
- **Разделение ролей**: ADMIN (полный доступ), EDITOR (управление контентом).
- **Кодирование BCrypt** для безопасности паролей.

### Управление средами
- **Локально**: Файл `.env` (игнорируется git).
- **CI/CD**: GitHub Actions → Секреты репозитория.
- **Продакшен**: Переменные окружения или файлы секретов.

---

## Лучшие практики
- Храните в `application.yml` только минимальные настройки по умолчанию (без секретов).
- Используйте `.env` только для локальной разработки; добавляйте `.env.example` в репозиторий как шаблон.
- Конфигурации для продакшена (профиль `prod`) должны читать данные только из переменных окружения.
- Согласуйте управление схемой БД для каждой среды: `update` локально, `validate` в продакшене.