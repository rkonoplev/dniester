# Руководство по конфигурации

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Содержание
- [Расположение файлов конфигурации](#расположение-файлов-конфигурации)
- [Конфигурация для тестов](#конфигурация-для-тестов)
- [Матрица профилей Spring](#матрица-профилей-spring)
- [Запуск с профилями](#запуск-с-профилями)
- [Переменные окружения и .env](#переменные-окружения-и-env)
- [Управление секретами](#управление-секретами)
- [Лучшие практики](#лучшие-практики)


Этот документ объясняет стратегию конфигурации для бэкенда Phoebe CMS.  
Профили Spring Boot, файлы конфигурации YAML и переменные окружения используются для обеспечения безопасности,
портативности и консистентности системы в различных средах.

---

## Расположение файлов конфигурации

Конфигурация приложения разделена между двумя основными директориями:

1.  **`backend/src/main/resources/`**
    - Содержит конфигурацию для запуска основного приложения (локально, в CI, на продакшене).
    - `application.yml` — базовый файл, содержит общие для всех сред настройки.
    - `application-<profile>.yml` — файлы для конкретных сред, которые переопределяют или дополняют базовые
      настройки.

2.  **`backend/src/test/resources/`**
    - Содержит конфигурацию **только для запуска тестов**.
    - Настройки из этой директории имеют **более высокий приоритет** и переопределяют одноименные файлы из
      `main/resources` во время тестового запуска.

Spring Boot выбирает конфигурацию на основе активного профиля (`SPRING_PROFILES_ACTIVE`).

---

## Конфигурация для тестов

Для тестов используется отдельный набор конфигурационных файлов в `src/test/resources/`, что позволяет
изолировать тестовую среду от основной.

- **`application.yml`** (в `test`) — базовый файл для всех тестов. Он переопределяет основной `application.yml`
  и обычно содержит настройки логирования и другие общие для тестов параметры.
- **`application-test.yml`** — используется по умолчанию, если в тестовом классе не указан активный профиль
  (`@ActiveProfiles`). Настроен на использование быстрой встраиваемой базы данных H2.
- **`application-integration-test.yml`** — специальный профиль для интеграционных тестов, которые требуют
  подключения к реальной базе данных (например, в Docker). Этот профиль нужно активировать явно через
  `@ActiveProfiles("integration-test")`.

---

## Матрица профилей Spring

| Профиль            | Файл                               | База данных        | Стратегия схемы | Использование                                                               |
|:-------------------|:-----------------------------------|:-------------------|:----------------|:----------------------------------------------------------------------------|
| `local`            | `application-local.yml`            | MySQL (Docker)     | `update`        | Локальная разработка с `docker-compose`; использует `.env` для учетных данных БД. |
| `dev`              | `application-dev.yml`              | Зависит от вендора | `update`        | Разработка/staging; комбинируется с профилем `mysql` или `postgresql`.      |
| `test`             | `application-test.yml`             | H2 (в памяти)      | `create-drop`   | **(Только для тестов)** Юнит-тесты и быстрые интеграционные тесты в IDE. Используется по умолчанию. |
| `integration-test` | `application-integration-test.yml` | MySQL (Docker)     | `validate`      | **(Только для тестов)** Полные интеграционные тесты, требующие реальной БД. |
| `ci`               | `application-ci.yml`               | H2 (в памяти)      | `create-drop`   | CI в GitHub Actions; быстрые и изолированные сборки без внешней БД.         |
| `prod`             | `application-prod.yml`             | Облачная БД (MySQL/PG)| `validate`      | Продакшен; комбинируется с профилем вендора. Секреты через ENV.             |
| `mysql`            | `application-mysql.yml`            | MySQL              | `validate`      | **Профиль вендора.** Устанавливает путь к миграциям Flyway для MySQL.       |
| `postgresql`       | `application-postgresql.yml`       | PostgreSQL         | `validate`      | **Профиль вендора.** Устанавливает путь к миграциям Flyway для PostgreSQL.  |
| `security`         | `application-security.yml`         | -                  | -               | Активирует или переопределяет настройки, связанные с безопасностью.         |

**Примечание**: Профили можно комбинировать. Например, в продакшене используется `prod,mysql` или `prod,postgresql`.

---

## Запуск с профилями

Профили можно установить с помощью переменной окружения `SPRING_PROFILES_ACTIVE` или аргумента JVM.

```bash
# Запуск с комбинированным профилем dev и mysql
SPRING_PROFILES_ACTIVE=dev,mysql ./gradlew bootRun

# Запуск тестов с профилем CI
SPRING_PROFILES_ACTIVE=ci ./gradlew test

# Пример для Docker-контейнера в продакшене
docker run -d -e SPRING_PROFILES_ACTIVE=prod,postgresql --env-file .env.prod phoebe:latest
```
Если профиль не указан, для основного приложения по умолчанию используется `local`, а для тестов — `test`.

## Переменные окружения и .env

### Локальная разработка (.env)
Файл `.env` (игнорируется git) предоставляет учетные данные для БД и приложения локально.
В репозиторий включен файл `.env.example` с плейсхолдерами.

Пример `.env`:
```# Учетные данные MySQL
MYSQL_ROOT_PASSWORD=rootpass
MYSQL_DATABASE=newsdb
MYSQL_USER=newsuser
MYSQL_PASSWORD=newspass

# Порты
SPRING_LOCAL_PORT=8080
DATABASE_LOCAL_PORT=3306

# Источник данных Spring
SPRING_DATASOURCE_URL=jdbc:mysql://mysql:${DATABASE_LOCAL_PORT}/newsdb?useUnicode=true&characterEncoding=utf8mb4&useSSL=false
SPRING_DATASOURCE_USERNAME=${MYSQL_USER}
SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}

# Учетные данные для аутентификации (Basic Auth)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=changemeAdmin
EDITOR_USERNAME=editor
EDITOR_PASSWORD=changemeEditor

# Ограничение запросов (опционально, если не задано, применяются значения по умолчанию)
# PUBLIC_RATE_LIMIT=100
# ADMIN_RATE_LIMIT=50
```
**Примечание**: Секреты никогда не должны попадать в git. В систему контроля версий включается только `.env.example`.

## Управление секретами

### Безопасность аутентификации
- **Текущая реализация**: Basic Auth с учетными данными пользователей из базы данных.
- **Разделение ролей**: ADMIN (полный доступ), EDITOR (управление контентом).
- **Планируемая миграция**: OAuth 2.0 + 2FA для ролей ADMIN и EDITOR, замена Basic Auth.
- **Кодирование BCrypt** для безопасности паролей (текущая реализация).

### Управление средами
- **Локально**: Файл `.env` (игнорируется git).
- **CI/CD**: GitHub Actions → Секреты репозитория.
- **Продакшен**: Переменные окружения или файлы секретов, монтируемые во время выполнения.
- Пароли, токены и учетные данные администратора всегда должны внедряться через переменные окружения.
- Никогда не прописывайте секреты в файлах `application-*.yml` и не коммитьте реальные учетные данные.

## Лучшие практики
- Храните в `application.yml` только минимальные настройки по умолчанию (без секретов).
- Используйте `.env` только для локальной разработки; добавляйте `.env.example` в репозиторий как шаблон.
- Конфигурации для продакшена (профиль `prod`) должны читать данные только из переменных окружения.
- Согласуйте управление схемой БД для каждой среды: `update` локально, `validate` в продакшене.
