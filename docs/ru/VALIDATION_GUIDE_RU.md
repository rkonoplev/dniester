# Руководство по валидации и обработке контента

## Обзор

Phoebe CMS реализует комплексную валидацию входных данных и обработку контента для обеспечения целостности данных, безопасности и пользовательского опыта. Данное руководство охватывает все механизмы валидации, санитизацию HTML и обработку YouTube контента.

## Архитектура валидации

### Основные компоненты

1. **Система BaseException** - Стандартизированная обработка ошибок с HTTP статус-кодами
2. **SafeHtml валидация** - Пользовательская санитизация HTML и обработка YouTube
3. **Валидация сущностей** - Аннотации Bean Validation (JSR-303)
4. **Сервис обработки контента** - Автоматическая трансформация контента

## SafeHtml валидация

### Назначение
Защищает от XSS атак, позволяя безопасный HTML контент и автоматическое преобразование YouTube embed кода.

### Разрешенные HTML теги
- `img` - Изображения
- `b`, `strong` - Жирный текст
- `i`, `em` - Курсив/выделенный текст
- `a` - Ссылки
- `u` - Подчеркнутый текст
- `iframe` - YouTube embed (автогенерируемые)
- `div` - Контейнер для адаптивных YouTube embed

### Обработка YouTube ссылок

#### Поддерживаемые форматы
- Стандартная: `https://www.youtube.com/watch?v=VIDEO_ID`
- Короткая: `https://youtu.be/VIDEO_ID`

#### Автоматическое преобразование
YouTube ссылки автоматически преобразуются в адаптивный embed код:

```html
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/VIDEO_ID" 
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
          frameborder="0" allowfullscreen></iframe>
</div>
```

#### Адаптивный дизайн
- Соотношение сторон 16:9 сохраняется
- Подстраивается под размер экрана устройства
- Мобильно-дружественная реализация

## Правила валидации сущностей

### Сущность News (Новости)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `title` | `@NotBlank`, `@Size(max=50)` | Обязательное, макс 50 символов |
| `body` | `@SafeHtml` | Разрешает безопасный HTML + YouTube embed |
| `teaser` | `@SafeHtml`, `@Size(max=250)` | Безопасный HTML, макс 250 символов |
| `author` | `@NotNull` | Обязательная ссылка на автора |

### Сущность User (Пользователь)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `username` | `@NotBlank`, `@Size(min=3, max=50)` | 3-50 символов, уникальное |
| `email` | `@NotBlank`, `@Email`, `@Size(max=100)` | Валидный формат email |
| `password` | `@NotBlank`, `@Size(min=8)` | Минимум 8 символов |
| `firstName` | `@Size(max=50)` | Опциональное, макс 50 символов |
| `lastName` | `@Size(max=50)` | Опциональное, макс 50 символов |

### Сущность Term (Термин)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `name` | `@NotBlank`, `@Size(max=100)` | Обязательное, макс 100 символов |
| `description` | `@Size(max=500)` | Опциональное, макс 500 символов |

### Сущность Role (Роль)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `name` | `@NotBlank`, `@Size(max=50)` | Обязательное, макс 50 символов |
| `description` | `@Size(max=200)` | Опциональное, макс 200 символов |

## Обработка исключений

### Иерархия исключений
- `BaseException` - Абстрактная база с кодами ошибок
- `ValidationException` - HTTP 400 (Bad Request)
- `BusinessException` - HTTP 409 (Conflict)

### Коды ошибок
- `VALIDATION_ERROR` - Ошибка валидации входных данных
- `BUSINESS_RULE_VIOLATION` - Нарушение бизнес-правил
- `UNSAFE_HTML_CONTENT` - Ошибка санитизации HTML

## Сервис обработки контента

### Использование
```java
@Autowired
private ContentProcessingService contentService;

public void processNewsContent(News news) {
    String processedBody = contentService.processContent(news.getBody());
    news.setBody(processedBody);
}
```

### Возможности
- Автоматическое обнаружение и преобразование YouTube ссылок
- Валидация санитизации HTML
- Генерация адаптивного embed кода
- Защита от XSS

## Соображения безопасности

### Предотвращение XSS
- Весь HTML контент валидируется по белому списку
- Выполнение JavaScript заблокировано
- Разрешены только безопасные HTML теги
- YouTube embed использует доверенный домен

### Санитизация входных данных
- Аннотации Bean Validation на всех сущностях
- Пользовательский SafeHtml валидатор для полей контента
- Автоматическая обработка контента перед сохранением

## Тестирование

### Тесты валидации
```bash
./gradlew test --tests SafeHtmlValidatorTest
./gradlew test --tests ContentProcessingServiceTest
```

### Покрытие тестами
- Преобразование YouTube ссылок (стандартные и короткие URL)
- Валидация HTML тегов
- Генерация адаптивного embed
- Предотвращение XSS атак

## Файлы реализации

### Основные классы
- `SafeHtml.java` - Пользовательская аннотация валидации
- `SafeHtmlValidator.java` - Логика санитизации HTML
- `ContentProcessingService.java` - Трансформация контента
- `BaseException.java` - База иерархии исключений

### Классы сущностей
- `News.java` - Валидация новостных статей
- `User.java` - Валидация пользовательских аккаунтов
- `Term.java` - Валидация терминов таксономии
- `Role.java` - Валидация пользовательских ролей

## Лучшие практики

1. **Всегда валидируйте пользовательский ввод** на уровне сущности
2. **Используйте аннотацию SafeHtml** для полей контента
3. **Обрабатывайте контент** перед сохранением через ContentProcessingService
4. **Обрабатывайте исключения** с правильными HTTP статус-кодами
5. **Тщательно тестируйте правила валидации**
6. **Держите список разрешенных HTML тегов минимальным** для безопасности