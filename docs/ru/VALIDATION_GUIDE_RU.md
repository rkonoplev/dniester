# Руководство по валидации и обработке контента

## Обзор

Phoebe CMS реализует комплексную валидацию входных данных и обработку контента
для обеспечения целостности данных, безопасности и пользовательского опыта.
Данное руководство охватывает все механизмы валидации, санитизацию HTML и
обработку YouTube контента.

## Архитектура валидации

### Основные компоненты

1. **Система BaseException** - Стандартизированная обработка ошибок с HTTP
   статус-кодами
2. **SafeHtml валидация** - Пользовательская санитизация HTML и обработка
   YouTube
3. **Валидация сущностей** - Аннотации Bean Validation (Jakarta Validation / JSR-380)
4. **Сервис обработки контента** - Автоматическая трансформация
   контента

### Размещение валидации в приложении

Валидация входных данных в Spring Boot приложении Phoebe CMS обычно применяется на следующих уровнях:

-   **Уровень контроллера (Controller Layer)**: Это первое место, где происходит валидация входящих DTO (Data Transfer Objects) или сущностей. Используются аннотации `@Valid` или `@Validated` вместе с аннотациями Bean Validation. Это гарантирует, что некорректные данные не попадут в бизнес-логику.
-   **Уровень сервиса (Service Layer)**: В некоторых случаях, когда валидация зависит от сложной бизнес-логики или состояния базы данных, она может быть выполнена на уровне сервиса. Это также полезно для валидации вложенных объектов или коллекций, где `@Valid` или `@Validated` могут быть применены к полям DTO, содержащим другие DTO или списки.

## SafeHtml валидация

### Назначение
Защищает от XSS атак, позволяя безопасный HTML контент и автоматическое
преобразование YouTube embed кода.

### Разрешенные HTML теги
- `img` - Изображения
- `b`, `strong` - Жирный текст
- `i`, `em` - Курсив/выделенный текст
- `a` - Ссылки
- `u` - Подчеркнутый текст
- `p` - Параграфы
- `iframe` - YouTube embed (автогенерируемые)
- `div` - Контейнер для адаптивных YouTube embed

### Обработка YouTube ссылок

#### Поддерживаемые форматы
- Стандартная: `https://www.youtube.com/watch?v=VIDEO_ID`
- Короткая: `https://youtu.be/VIDEO_ID`

#### Автоматическое преобразование
YouTube ссылки автоматически преобразуются в адаптивный embed код:

```html
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/VIDEO_ID" 
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
          frameborder="0" allowfullscreen></iframe>
</div>
```

#### Адаптивный дизайн
- Соотношение сторон 16:9 сохраняется
- Подстраивается под размер экрана устройства
- Мобильно-дружественная реализация

## Правила валидации сущностей

### Валидация вложенных объектов и коллекций

Для валидации полей, которые сами являются объектами (DTO) или коллекциями объектов, используются аннотации `@Valid` или `@Validated`. Например:

```java
public class ParentDTO {
    @NotBlank
    private String name;

    @Valid // Валидация вложенного объекта ChildDTO
    private ChildDTO child;

    @Valid // Валидация каждого элемента в коллекции
    private List<AnotherChildDTO> childrenList;

    // ... getters and setters
}
```

### Сущность News (Новости)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `title` | `@NotBlank`, `@Size(max=50)` | Обязательное, макс 50 символов |
| `body` | `@SafeHtml` | Разрешает безопасный HTML + YouTube embed |
| `teaser` | `@SafeHtml`, `@Size(max=250)` | Безопасный HTML, макс 250 символов |
| `author` | `@NotNull` | Обязательная ссылка на автора |

### Сущность User (Пользователь)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `username` | `@NotBlank`, `@Size(min=3, max=50)` | 3-50 символов, уникальное |
| `email` | `@NotBlank`, `@Email`, `@Size(max=100)` | Валидный формат email |
| `password` | `@NotBlank`, `@Size(min=8)` | Минимум 8 символов |
| `firstName` | `@Size(max=50)` | Опциональное, макс 50 символов |
| `lastName` | `@Size(max=50)` | Опциональное, макс 50 символов |

### Сущность Term (Термин)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `name` | `@NotBlank`, `@Size(max=100)` | Обязательное, макс 100 символов |
| `description` | `@Size(max=500)` | Опциональное, макс 500 символов |

### Сущность Role (Роль)

| Поле | Правила валидации | Описание |
|------|-------------------|----------|
| `name` | `@NotBlank`, `@Size(max=50)` | Обязательное, макс 50 символов |
| `description` | `@Size(max=200)` | Опциональное, макс 200 символов |

## Обработка исключений

### Иерархия исключений
- `BaseException` - Абстрактная база с кодами ошибок
- `ValidationException` - HTTP 400 (Bad Request)
- `BusinessException` - HTTP 409 (Conflict)

### Коды ошибок
- `VALIDATION_ERROR` - Ошибка валидации входных данных
- `BUSINESS_RULE_VIOLATION` - Нарушение бизнес-правил
- `UNSAFE_HTML_CONTENT` - Ошибка санитизации HTML

### Пример стандартизированного ответа об ошибке валидации

При возникновении `ValidationException` или других ошибок валидации, API возвращает стандартизированный JSON-ответ, который включает HTTP статус, код ошибки, сообщение и, при необходимости, детали по полям:

```json
{
  "timestamp": "2023-10-27T10:30:00.123+00:00",
  "status": 400,
  "error": "Bad Request",
  "code": "VALIDATION_ERROR",
  "message": "Ошибка валидации входных данных",
  "details": [
    {
      "field": "title",
      "message": "не должно быть пустым"
    },
    {
      "field": "email",
      "message": "должен быть валидным адресом электронной почты"
    }
  ],
  "path": "/api/admin/news"
}
```

## Сервис обработки контента

### Взаимосвязь SafeHtml и ContentProcessingService

Аннотация `@SafeHtml` используется для маркировки полей, требующих санитизации HTML и обработки YouTube-ссылок. `SafeHtmlValidator` (реализация валидатора для `@SafeHtml`) использует `ContentProcessingService` для выполнения фактической санитизации и преобразования. Таким образом, `ContentProcessingService` является центральным компонентом, который выполняет всю сложную логику обработки контента, а `@SafeHtml` предоставляет удобный декларативный способ применения этой логики.

### Использование
```java
@Autowired
private ContentProcessingService contentService;

public void processNewsContent(News news) {
    String processedBody = contentService.processContent(news.getBody());
    news.setBody(processedBody);
}
```

### Возможности
- Автоматическое обнаружение и преобразование YouTube ссылок
- Валидация санитизации HTML
- Генерация адаптивного embed кода
- Защита от XSS

## Соображения безопасности

### Предотвращение XSS
- Весь HTML контент валидируется по белому списку
- Выполнение JavaScript заблокировано
- Разрешены только безопасные HTML теги
- YouTube embed использует доверенный домен `youtube.com` для обеспечения безопасности, что жестко закодировано в логике преобразования.

### Санитизация входных данных
- Аннотации Bean Validation на всех сущностях
- Пользовательский SafeHtml валидатор для полей контента
- Автоматическая обработка контента перед сохранением

## Тестирование

### Тесты валидации
```bash
./gradlew test --tests SafeHtmlValidatorTest
./gradlew test --tests ContentProcessingServiceTest
```

### Покрытие тестами
- Преобразование YouTube ссылок (стандартные и короткие URL)
- Валидация HTML тегов
- Генерация адаптивного embed
- Предотвращение XSS атак

## Файлы реализации

### Основные классы
- `SafeHtml.java` - Пользовательская аннотация валидации
- `SafeHtmlValidator.java` - Логика санитизации HTML
- `ContentProcessingService.java` - Трансформация контента
- `BaseException.java` - База иерархии исключений
- `GlobalExceptionHandler.java` - Централизованная обработка исключений и формирование стандартизированных ответов.

### Классы сущностей
- `News.java` - Валидация новостных статей
- `User.java` - Валидация пользовательских аккаунтов
- `Term.java` - Валидация терминов таксономии
- `Role.java` - Валидация пользовательских ролей
- `Permissions.java` - Валидация разрешений

## Лучшие практики

1. **Всегда валидируйте пользовательский ввод** на уровне сущности (DTO) и/или сервиса.
2. **Используйте аннотацию SafeHtml** для полей контента, содержащих HTML.
3. **Обрабатывайте контент** перед сохранением через ContentProcessingService.
4. **Обрабатывайте исключения** с правильными HTTP статус-кодами и стандартизированными ответами.
5. **Тщательно тестируйте правила валидации** и логику обработки контента.
6. **Держите список разрешенных HTML тегов минимальным** для максимальной безопасности.
7. **Используйте `@Valid` или `@Validated`** для валидации вложенных объектов и коллекций.