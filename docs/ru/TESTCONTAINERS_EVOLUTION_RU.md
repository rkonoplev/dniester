# Эволюция Testcontainers и стратегия

Этот документ объясняет эволюцию стратегий тестирования в проекте Phoebe CMS и предоставляет руководство о том, когда использовать Testcontainers.

---

## Текущий статус реализации

**Гибридная стратегия тестирования** с конфигурациями для разных сред:

- **Unit тесты**: Используют моки без зависимостей от базы данных
- **Локальные интеграционные тесты**: Используют Testcontainers MySQL через `LocalIntegrationTest`
- **CI интеграционные тесты**: Используют внешний MySQL из Docker Compose через `AbstractIntegrationTest`
- **Консистентность продакшена**: Все среды используют реальные экземпляры MySQL

---

## Исторический контекст: Зачем был нужен Testcontainers

### Первоначальное назначение
Testcontainers изначально рассматривался для:

1. **Локальных интеграционных тестов** - Запуск тестов без необходимости настройки Docker Compose
2. **Изоляции тестов** - Каждый набор тестов получает свой контейнер базы данных
3. **Автоматического управления жизненным циклом** - Контейнеры запускаются/останавливаются автоматически с тестами
4. **Опыта разработчика** - Не требуется ручная настройка базы данных

### Предыдущий подход (с Testcontainers)
```java
@Testcontainers
class IntegrationTest {
    @Container
    static MySQLContainer mysql = new MySQLContainer("mysql:8.0")
            .withDatabaseName("testdb")
            .withUsername("test")
            .withPassword("test");
    
    // Автоматически запускает/останавливает MySQL для каждого теста
}
```

---

## Эволюция текущей архитектуры

### Современный подход (гибридная стратегия)

**Unit тесты:**
- **Без базы данных** - Чистые моки для быстрого выполнения
- **Профиль**: `test`
- **Преимущества**: Мгновенный запуск, изолированное тестирование

**Локальные интеграционные тесты:**
- **MySQL через Testcontainers** - Реальные экземпляры БД для локальной разработки
- **Профиль**: `integration-test`
- **Класс**: `LocalIntegrationTest`
- **Преимущества**: Не требуется настройка Docker Compose, автоматическое управление жизненным циклом

**CI интеграционные тесты:**
- **MySQL через Docker Compose** - Внешний сервис MySQL
- **Профиль**: `ci-integration`
- **Класс**: `AbstractIntegrationTest`
- **Преимущества**: Более быстрое выполнение CI, общий сервис базы данных

**Продакшен:**
- **База данных MySQL** - Идентична всем тестовым средам
- **Профиль**: `prod`
- **Преимущества**: 100% консистентность во всех средах

### Сравнение архитектур

| Аспект | Предыдущий подход H2 | Текущий MySQL-only + Testcontainers |
|--------|---------------------|-------------------------------------|
| **Соответствие продакшену** | Низкое (H2 ≠ MySQL) | Высокое (MySQL везде) |
| **Надежность тестов** | Средняя (различия БД) | Высокая (идентичные БД) |
| **Консистентность CI** | Низкая (разные БД) | Высокая (одна технология) |
| **Сложность настройки** | Низкая | Средняя |
| **Использование ресурсов** | Ниже | Выше, но оправдано |

---

## Почему мы приняли Testcontainers

### Технические преимущества
1. **Консистентность продакшена** - Одна технология БД во всех средах
2. **Надежность тестов** - Нет проблем совместимости баз данных
3. **Изоляция** - Каждый набор тестов получает чистое состояние БД
4. **Автоматическое управление** - Контейнеры запускаются/останавливаются автоматически

### Стратегические преимущества
1. **Подход "продакшн-первый"** - Тестирование точно отражает продакшен
2. **Упрощенная архитектура** - Нет сложности абстракции БД
3. **Уверенность разработчика** - Тесты валидируют реальные продакшн-сценарии
4. **Надежность CI/CD** - Консистентное поведение во всех средах

---

## Когда использовать Testcontainers

### ✅ Рекомендуемые сценарии

**1. Сложные взаимодействия с базой данных**
- Тестирование хранимых процедур
- Специфичные для базы данных функции (различия MySQL vs PostgreSQL)
- Сложные сценарии транзакций

**2. Тестирование нескольких баз данных**
- Тестирование против нескольких версий баз данных
- Валидация совместимости между базами данных
- Тестирование миграций баз данных

**3. Интеграция с внешними сервисами**
- Тестирование с Redis, Elasticsearch и т.д.
- Интеграция очередей сообщений (RabbitMQ, Kafka)
- Мокирование сторонних сервисов

**4. Изолированные тестовые среды**
- Когда тесты не должны мешать друг другу
- Тестирование сценариев повреждения данных
- Тестирование производительности с реалистичными объемами данных

### ❌ Не рекомендуемые сценарии

**1. Простые CRUD операции**
- Базовая персистентность сущностей
- Стандартные JPA операции
- Тестирование простой бизнес-логики

**2. Быстрые циклы разработки**
- Юнит-тестирование
- TDD рабочие процессы
- Быстрое прототипирование

**3. Среды с ограниченными ресурсами**
- Ограниченные ресурсы CI/CD
- Ноутбуки разработчиков с ограниченной RAM
- Общие среды разработки

---

## Стратегия реализации

### Текущая реализация: MySQL-only с Testcontainers

**Детали реализации:**
- **Unit тесты** - Разделены в директорию `/unit/`, используют только моки
- **Интеграционные тесты** - Расположены в директории `/integration/`, используют Testcontainers
- **AbstractIntegrationTest** - Базовый класс с конфигурацией MySQL контейнера
- **Конфигурация Gradle** - Правильное разделение sourceSets

**Текущее использование:**

**1. Локальная разработка (с Testcontainers)**
```java
@ActiveProfiles("integration-test")
@Testcontainers
class MyIntegrationTest extends LocalIntegrationTest {
    // Testcontainers MySQL настраивается автоматически
    // Не требуется настройка Docker Compose
}
```

**2. CI среда (с Docker Compose)**
```java
@ActiveProfiles("ci-integration")
class MyIntegrationTest extends AbstractIntegrationTest {
    // Использует внешний MySQL из Docker Compose
    // Более быстрое выполнение CI, нет накладных расходов на запуск контейнера
}
```

**3. Стратегия конфигурации**
```yaml
# application-integration-test.yml (Локально)
spring:
  datasource:
    url: # Устанавливается динамически Testcontainers
  jpa:
    hibernate:
      ddl-auto: validate
  flyway:
    enabled: true

# application-ci-integration.yml (CI)
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/phoebe_db
    username: root
    password: root
```

---

## Заключение

**Текущий статус**: Testcontainers **активно реализован** как часть стратегии "продакшн-первый" MySQL-only.

**Достигнутые преимущества**:
- 100% консистентность продакшена во всех средах
- Надежное интеграционное тестирование с реальными экземплярами MySQL
- Упрощенная архитектура без абстракции базы данных
- Уверенность разработчика в готовом к продакшену коде

**Руководящие принципы использования**:
- Используйте **unit тесты** для бизнес-логики с моками
- Используйте **LocalIntegrationTest** для локальной разработки (автоматические Testcontainers)
- Используйте **AbstractIntegrationTest** для CI среды (внешний Docker Compose MySQL)
- Оба подхода используют реальный MySQL для консистентности продакшена
- CI оптимизирован для скорости за счет переиспользования общего сервиса MySQL