> [Вернуться к содержанию документации](./README.md)

# ADR: Унификация стратегии тестирования с помощью Testcontainers

Этот документ является записью архитектурного решения (ADR) и описывает исторический контекст и причины перехода на унифицированную стратегию тестирования с использованием Testcontainers.

> **Важно:** Этот документ описывает, *почему* была принята текущая стратегия. Для получения практических инструкций по запуску тестов и разработке, пожалуйста, обратитесь к следующим руководствам:
> - **[Тестирование и разработка с Makefile](./TESTING_WITH_MAKEFILE_RU.md)** (для локальной работы)
> - **[Руководство по CI/CD](./CI_CD_GUIDE_RU.md)** (для понимания процесса в CI)

---

## Исторический контекст

Изначально в проекте существовал гибридный подход к тестированию, который включал в себя различные стратегии для локальной разработки, CI и юнит-тестов. Это приводило к несогласованности окружений, усложняло настройку и снижало надежность тестов.

Целью перехода на Testcontainers было:
1.  **Унифицировать окружение**: Использовать MySQL во всех средах (локально, CI, продакшен).
2.  **Изолировать тесты**: Гарантировать, что каждый тестовый запуск работает с чистой базой данных.
3.  **Упростить разработку**: Автоматизировать управление жизненным циклом БД для тестов, избавляя от необходимости ручной настройки.

## Сравнение архитектур

| Аспект | Предыдущий гибридный подход | Текущий унифицированный подход |
|---|---|---|
| **Соответствие продакшену** | Среднее (H2/Docker Compose) | Высокое (MySQL везде) |
| **Надежность тестов** | Средняя (различия сред) | Высокая (идентичные среды) |
| **Сложность настройки** | Высокая (множественные конфигурации) | Низкая (единый подход через `Makefile` и `BaseIntegrationTest`) |
| **Консистентность CI/CD** | Средняя | Высокая (Testcontainers используется и локально, и в CI) |

---

## Принятое решение: Унифицированный подход с Testcontainers

Было решено полностью перейти на Testcontainers для всех интеграционных тестов, отказавшись от H2 и ручного управления Docker Compose для тестов.

### Технические и стратегические преимущества

1.  **Подход "продакшн-первый"**: Тестирование всегда выполняется на той же технологии базы данных, что и в продакшене.
2.  **Надежность и консистентность**: Тесты ведут себя одинаково как на машине разработчика, так и в CI.
3.  **Упрощение архитектуры**: Единый базовый класс `BaseIntegrationTest` и профиль `integration-test` для всех интеграционных тестов.
4.  **Уверенность разработчика**: Успешное прохождение тестов дает большую уверенность в том, что код будет работать в продакшене.
5.  **Упрощение CI**: Конвейер CI не зависит от внешних сервисов баз данных и сложных настроек.

---

## Заключение

Проект полностью перешел на унифицированную стратегию тестирования, где **Testcontainers** является единственным инструментом для управления базами данных в интеграционных тестах. Это решение позволило добиться высокой консистентности, надежности и упрощения как локальной разработки, так и процесса непрерывной интеграции.