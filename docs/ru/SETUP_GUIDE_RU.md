# Руководство по установке и развертыванию

Этот документ — ваш главный путеводитель по развертыванию проекта. Он описывает все возможные сценарии,
от быстрого старта для нового разработчика до миграции данных с нового сайта на Drupal 6.

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Требования

Для успешной установки и запуска проекта Phoebe CMS вам понадобится следующее программное обеспечение:

-   **JDK 21+**: Java Development Kit версии 21 или новее.
-   **Docker & Docker Compose**: Инструменты для управления локальной средой разработки.
-   **Git**: Для клонирования репозитория проекта.

---

## Первоначальная настройка проекта

Прежде чем перейти к какому-либо сценарию, необходимо клонировать репозиторий и настроить переменные окружения.

1.  **Клонируйте репозиторий**:
    ```bash
    git clone https://github.com/rkonoplev/phoebe.git
    cd phoebe
    ```

2.  **Настройте переменные окружения**:
    Скопируйте файл-пример для создания вашей локальной конфигурации:
    ```bash
    cp .env.dev.example .env.dev
    ```
    Затем отредактируйте `.env.dev` в соответствии с настройками для выбранного сценария ниже.

---

## Выбор сценария развертывания

Выберите сценарий, который соответствует вашей задаче, и перейдите к подробным инструкциям ниже.

- **[Сценарий A: Быстрый старт для нового разработчика (Рекомендуемый)](#сценарий-a-быстрый-старт-для-нового-разработчика-рекомендуемый)**
  - **Цель:** Максимально быстро запустить проект локально с полной, готовой базой данных.

- **[Сценарий B: Чистая установка (новый сайт)](#сценарий-b-чистая-установка-новый-сайт)**
  - **Цель:** Запустить проект без исторических данных, чтобы начать наполнять полностью новый сайт.

- **[Сценарий C: Миграция НОВОГО сайта с Drupal 6](#сценарий-c-миграция-нового-сайта-с-drupal-6)**
  - **Цель:** У вас есть дамп от **другого** сайта на Drupal 6, и вы хотите перенести его данные.

- **[Сценарий D: Резервное копирование и восстановление](#сценарий-d-резервное-копирование-и-восстановление-текущей-работы)**
  - **Цель:** Сохранить текущее состояние вашей локальной базы данных для переноса или на случай сбоя.

---

## Подробные инструкции по сценариям

### Сценарий A: Быстрый старт для нового разработчика (Рекомендуемый)

Этот процесс полностью автоматизирован и является стандартным для входа в проект.

1.  **Выполните** шаги из раздела [Первоначальная настройка проекта](#первоначальная-настройка-проекта).
2.  **Запустите все одной командой:** `docker compose up --build`.

**Результат:** Flyway автоматически создаст базу и наполнит ее всеми данными из скрипта `V3__insert_sample_data.sql`.
Подробности процесса описаны в **[Актуальном руководстве по миграции](./MODERN_MIGRATION_GUIDE_RU.md)**.

---

### Сценарий B: Чистая установка (новый сайт)

Этот сценарий предназначен для начала работы с нуля. Вы можете выбрать любую из поддерживаемых СУБД.

1.  **Отключите миграцию с данными.**
    - Перейдите в `backend/src/main/resources/db/migration/common/`.
    - Найдите скрипт, ответственный за вставку данных (например, `V3__insert_sample_data.sql`).
    - **Переименуйте** его, изменив префикс с `V` на `_V` (например, `_V3__insert_sample_data.sql`).
      Это заставит Flyway его проигнорировать.

2.  **Настройте Docker и переменные окружения** для выбранной СУБД (MySQL или PostgreSQL), как описано ниже.

3.  **Запустите приложение** с соответствующим профилем (`mysql` или `postgresql`).

#### Шаг 1: Настройте Docker Compose

Откройте файл `docker-compose.yml` и оставьте активным только один сервис базы данных:

- **Для MySQL**:
  ```yaml
  mysql:
    image: mysql:8.0
    # ... остальная конфигурация
  ```

- **Для PostgreSQL**:
  ```yaml
  postgres:
    image: postgres:13
    # ... остальная конфигурация
  ```

#### Шаг 2: Настройте переменные окружения (`.env.dev`)

- **Для MySQL**:
  ```dotenv
  SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/dniester?useUnicode=true&characterEncoding=utf8mb4&useSSL=false
  SPRING_DATASOURCE_USERNAME=root
  SPRING_DATASOURCE_PASSWORD=root
  ```

- **Для PostgreSQL**:
  ```dotenv
  SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/dniester
  SPRING_DATASOURCE_USERNAME=user
  SPRING_DATASOURCE_PASSWORD=password
  ```

#### Шаг 3: Запустите приложение с правильным профилем

1.  **Запустите Docker-контейнер** с выбранной базой данных:
    ```bash
    docker compose up -d mysql # или postgres
    ```

2.  **Запустите приложение**, указав соответствующий профиль СУБД:
    ```bash
    cd backend
    ./gradlew bootRun --args='--spring.profiles.active=local,mysql' # или postgresql
    ```

**Результат:** Flyway создаст все таблицы, но пропустит миграцию с данными. Вы получите чистую БД.

---

### Сценарий C: Миграция НОВОГО сайта с Drupal 6

Этот процесс требует повторения исторических шагов для преобразования вашего нового дампа в скрипт Flyway.

1.  **Изучите концепцию** ручной миграции в **[Историческом руководстве по миграции](./MIGRATION_DRUPAL6_RU.md)**.
    Этот документ подробно описывает, как с помощью временного контейнера MySQL 5.7 и набора
    трансформационных скриптов преобразовать "сырой" дамп в "чистый".

2.  **Выполните шаги** из исторического руководства, используя ваш **новый** дамп в качестве исходного.

3.  **Создайте новый скрипт Flyway.**
    - Результатом ручной миграции будет "чистый" SQL-файл с командами `INSERT`.
    - Создайте **новый** файл в `backend/src/main/resources/db/migration/common/` (например, `V7__add_data_from_new_site.sql`).
    - Поместите в него полученные команды `INSERT`.

---

### Сценарий D: Резервное копирование и восстановление текущей работы

Этот процесс остается ручным и предназначен для создания полных "снимков" вашей локальной базы данных.

- Все шаги и команды подробно описаны в **[Руководстве по резервному копированию](./DOCKER_DATA_RECOVERY_GUIDE_RU.md)**.

**Важно:** Восстановление из такого дампа может конфликтовать с состоянием миграций Flyway, поэтому
используйте этот метод с осторожностью, в основном для полного переноса окружения.
