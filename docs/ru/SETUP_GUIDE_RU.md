# Руководство по установке и развертыванию

Этот документ — ваш главный путеводитель по развертыванию проекта. Он описывает все возможные сценарии, от миграции существующего сайта до чистой установки.

> Для ежедневной работы с уже настроенным проектом, пожалуйста, обратитесь к **[Краткому руководству](./QUICK_START_RU.md)**.

---

## Требования

-   **JDK 21+**: Java Development Kit версии 21 или новее.
-   **Docker**: Необходим для запуска окружения.
-   **Git**: Для клонирования репозитория.
-   **Make**: (Рекомендуется) Для выполнения команд из `Makefile`.

---

## Первоначальная настройка

Перед выбором сценария выполните эти два шага:

1.  **Клонируйте репозиторий**:
    ```bash
    git clone https://github.com/rkonoplev/phoebe.git
    cd phoebe
    ```

2.  **Создайте файл окружения**:
    ```bash
    cp .env.example .env
    ```
    В большинстве случаев изменять `.env` не требуется.

---

## Выбор сценария развертывания

- **[Сценарий 1: Миграция существующего сайта с Drupal 6](#сценарий-1-миграция-существующего-сайта-с-drupal-6)**
  - **Цель**: У вас есть дамп базы данных от сайта на Drupal 6, и вы хотите перенести его данные в Phoebe CMS.

- **[Сценарий 2: Быстрый старт для нового разработчика (Рекомендуемый)](#сценарий-2-быстрый-старт-для-нового-разработчика-рекомендуемый)**
  - **Цель**: Максимально быстро запустить проект локально с полной, готовой базой данных, которая уже была ранее смигрирована.

- **[Сценарий 3: Чистая установка (новый сайт)](#сценарий-3-чистая-установка-новый-сайт)**
  - **Цель**: Запустить проект без исторических данных, чтобы начать наполнять полностью новый сайт с нуля.

- **[Сценарий 4: Резервное копирование и перенос проекта](#сценарий-4-резервное-копирование-и-перенос-проекта)**
  - **Цель**: Сохранить текущее состояние вашей локальной базы данных для переноса на другой компьютер.

- **[Сценарий 5: Развертывание в продакшен](#сценарий-5-развертывание-в-продакшен)**
  - **Цель**: Развернуть приложение на реальном сервере для публичного доступа.

---

### Сценарий 1: Миграция существующего сайта с Drupal 6

Этот сценарий для тех, у кого есть дамп базы данных Drupal 6 и кто хочет перенести его в новую систему.

1.  **Выполните трансформацию данных**: Следуйте инструкциям в **[Историческом руководстве по миграции](./MIGRATION_DRUPAL6_RU.md)**, чтобы преобразовать ваш дамп в финальный SQL-файл `clean_schema.sql`.

2.  **Настройте окружение для MySQL**: Убедитесь, что в `docker-compose.yml` и `.env` выбраны настройки для MySQL.

3.  **Запустите контейнер MySQL**:
    ```bash
    docker-compose up -d phoebe-mysql
    ```

4.  **Импортируйте новую схему**:
    ```bash
    docker exec -i phoebe-mysql mysql -uroot -proot phoebe_db < /путь/к/вашему/clean_schema.sql
    ```

5.  **Запустите приложение**:
    ```bash
    cd backend && ./gradlew bootRun
    ```
    Приложение подхватит уже существующую и наполненную базу данных.

---

### Сценарий 2: Быстрый старт для нового разработчика (Рекомендуемый)

Этот сценарий предполагает, что вся работа по миграции уже проделана, и вам нужно просто запустить проект с готовой базой данных.

1.  **Выполните** шаги из раздела [Первоначальная настройка](#первоначальная-настройка).
2.  **Запустите все одной командой**:
    ```bash
    make run
    ```
    *Альтернативная команда (без Makefile):* `docker compose up --build`

**Результат**: `docker-compose` поднимет приложение и базу данных. Flyway автоматически создаст схему и наполнит ее всеми данными из миграционных скриптов. Этот процесс подробно описан в **[Актуальном руководстве по миграции](./MODERN_MIGRATION_GUIDE_RU.md)**.

---

### Сценарий 3: Чистая установка (новый сайт)

Этот сценарий для тех, кто хочет начать с абсолютно пустой базы данных.

1.  **Отключите миграцию с данными**:
    - Перейдите в `backend/src/main/resources/db/migration/common/`.
    - Найдите скрипт, ответственный за вставку данных (например, `V3__insert_sample_data.sql`).
    - **Переименуйте** его, изменив префикс с `V` на `_V` (например, `_V3__insert_sample_data.sql`).

2.  **(Опционально) Выберите базу данных**:
    Проект по умолчанию использует MySQL. Для переключения на PostgreSQL:
    - **В `docker-compose.yml`**: закомментируйте сервис `phoebe-mysql` и раскомментируйте `phoebe-postgres`.
    - **В `.env`**: закомментируйте переменные для MySQL и раскомментируйте для PostgreSQL.
      ```dotenv
      #SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/phoebe_db
      #...
      SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/phoebe_db
      #...
      ```
    - **В `build.gradle`**: закомментируйте зависимость `mysql-connector-j` и раскомментируйте `postgresql`.

3.  **Запустите проект**:
    ```bash
    make run
    ```
    *Альтернативный запуск (без Makefile):*
    1. `docker compose up -d phoebe-mysql` (или `phoebe-postgres`)
    2. `cd backend && ./gradlew bootRun`

**Результат**: Flyway создаст все таблицы, но пропустит миграцию с данными. Вы получите чистую базу данных.

---

### Сценарий 4: Резервное копирование и перенос проекта

Этот процесс предназначен для создания "снимков" вашей локальной базы данных для переноса между рабочими машинами.

- Все шаги и команды подробно описаны в **[Руководстве по переносу Docker Volume с данными MySQL](./VOLUME_MIGRATION_GUIDE_RU.md)**.
- Для исторической справки о ручных процессах резервного копирования и восстановления, актуальных на ранних этапах проекта, см. **[Историческое руководство по резервному копированию и восстановлению данных Docker (контекст миграции Drupal 6)](./LEGACY_DOCKER_DATA_RECOVERY_GUIDE_RU.md)**.

---

### Сценарий 5: Развертывание в продакшен

Этот сценарий описывает перенос приложения из локальной разработки в "живую" среду (продакшен). Он включает в себя настройку сервера, управление секретами и использование Docker для развертывания.

Все подробные инструкции, требования к окружению и примеры конфигураций описаны в отдельном руководстве:

- **➡️ [Руководство по развертыванию в продакшене](./PRODUCTION_GUIDE_RU.md)**
