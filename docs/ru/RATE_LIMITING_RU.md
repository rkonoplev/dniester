# Руководство по ограничению частоты запросов

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Обзор
Phoebe CMS реализует ограничение частоты запросов на основе IP-адресов с использованием Bucket4j
для предотвращения злоупотреблений API и обеспечения справедливого использования ресурсов.

## Конфигурация

### Лимиты запросов
- **Публичный API** (`/api/public/**`): 100 запросов в минуту на один IP-адрес.
- **API администратора** (`/api/admin/**`): 50 запросов в минуту на один IP-адрес (более строгий лимит).

### Детали реализации
- **Библиотека**: Bucket4j 8.7.0 (актуальная версия на момент написания).
- **Стратегия**: Алгоритм "Token Bucket" с "корзинами" на основе IP.
- **Хранилище**: Внутрипроцессное (in-memory) `ConcurrentHashMap` (для каждого экземпляра приложения).
- **Восполнение**: Линейное восполнение каждую минуту.

### Место конфигурации лимитов
Лимиты запросов (количество запросов в минуту) для публичного и административного API конфигурируются в классе `RateLimitConfig`. Эти значения могут быть изменены путем редактирования соответствующих полей в этом классе или через внешнюю конфигурацию Spring (например, `application.yml`), если это предусмотрено.

## Компоненты

### RateLimitConfig
- Создает и управляет "корзинами" для разных типов API.
- Раздельные пулы "корзин" для публичного и административного API.
- Идентификация "корзин" на основе IP с префиксами (`public:IP`, `admin:IP`).

### RateLimitFilter
- Фильтр сервлетов, который перехватывает все запросы.
- Извлекает IP-адрес клиента из заголовков (`X-Forwarded-For`, `X-Real-IP`) или удаленного адреса.
- Применяет соответствующий лимит в зависимости от пути запроса.
- Возвращает HTTP 429 при превышении лимита.

## Тестирование лимитов

### Тест публичного API (100 запросов/мин):
```bash
# Единичный запрос
curl -i http://localhost:8080/api/public/news

# Быстрые запросы для срабатывания лимита
for i in {1..105}; do \
  curl -s -o /dev/null -w "%{http_code}\n" http://localhost:8080/api/public/news; \
done
```

### Тест API администратора (50 запросов/мин):
```bash
# С аутентификацией
for i in {1..55}; do \
  curl -s -o /dev/null -w "%{http_code}\n" -u admin:password http://localhost:8080/api/admin/news; \
done
```
*   **Примечание**: В примере используется базовая HTTP-аутентификация (`-u admin:password`). В продакшене рекомендуется использовать более надежные механизмы аутентификации, такие как OAuth 2.0 или JWT, как описано в [Руководстве по аутентификации](./AUTHENTICATION_GUIDE_RU.md).

## Заголовки ответа
- `X-Rate-Limit-Remaining`: Количество оставшихся запросов в текущем окне.
- `X-Rate-Limit-Retry-After-Seconds`: Время в секундах до сброса лимита (если лимит превышен).

## Ответ об ошибке
Когда лимит превышен (HTTP 429):
```json
{
  "error": "Rate limit exceeded",
  "retryAfter": 60
}
```

## Рекомендации для продакшена
- Текущая реализация использует хранилище в памяти (сбрасывается при перезапуске).
- Для распределенных систем (несколько экземпляров приложения) рассмотрите использование хранилища на базе Redis или другого внешнего хранилища, поддерживаемого Bucket4j.
- Отслеживайте метрики ограничения для планирования мощностей и выявления аномалий.

## Определение IP-адреса
Фильтр проверяет заголовки в следующем порядке:
1. `X-Forwarded-For` (прокси/балансировщик нагрузки)
2. `X-Real-IP` (обратный прокси)
3. `request.getRemoteAddr()` (прямое соединение)

Это обеспечивает корректную работу за прокси и балансировщиками нагрузки.
