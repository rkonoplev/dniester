# Обзор проекта Phoebe CMS

## Обзор проекта
**Название**: Phoebe — Headless CMS для новостных агентств и цифровых медиа  
**Тип**: Open Source Headless система управления контентом (гибридная архитектура)  
**Миграция**: Drupal 6 → Современный Headless Spring Boot + Опциональный Angular Frontend  
**Статус**: Headless Backend готов к продакшену, Референсный Frontend планируется  
**Лицензия**: MIT (Open Source)

## Технологический стек

### Headless Backend (Готов к продакшену)
- **Фреймворк**: Spring Boot 3.x
- **Язык**: Java 21
- **База данных**: MySQL 8.0, PostgreSQL 12+ (H2 для тестов)
- **Безопасность**: Spring Security с настраиваемой аутентификацией
- **API**: REST с документацией OpenAPI/Swagger
- **Кэширование**: Caffeine (In-Memory)
- **Ограничение запросов**: Bucket4j с IP-based buckets
- **Сборка**: Gradle 8.7
- **Тестирование**: JUnit 5, интеграционные тесты с H2
- **Миграция**: Spring Boot миграции (V1-V6)

### Референсный Frontend (Опциональный)
- **Фреймворк**: Angular с Angular Universal
- **Назначение**: Референсная реализация для малых медиа организаций
- **Дизайн**: Адаптивный макет в стиле Google News
- **SEO**: Статические URL, SSR, JSON-LD, OpenGraph метаданные
- **Брендинг**: Настраиваемая система тем
- **Функции**: Поиск, темная тема, push-уведомления (планируется)
- **Примечание**: Профессиональные команды могут создавать собственные frontend используя headless API

### Инфраструктура
- **Контейнеризация**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **Качество кода**: Checkstyle, PMD, JaCoCo coverage
- **База данных**: MySQL или PostgreSQL с Docker
- **Безопасность**: GitLeaks сканирование секретов

## Гибридная Headless архитектура

**Phoebe** следует **гибридному Headless** подходу, обеспечивая максимальную гибкость:

- **Headless ядро**: Полный REST API для разработки пользовательских frontend
- **Референсный Frontend**: Опциональное Angular приложение для быстрого развертывания
- **API-First**: Вся функциональность доступна через REST endpoints
- **Без привязки к поставщику**: Используйте наш frontend или создайте свой

## Структура проекта
```
phoebe/
├── backend/                    # Headless Spring Boot API
│   ├── src/main/java/com/example/newsplatform/
│   │   ├── config/            # Конфигурации безопасности, тестов, ограничений, кэша
│   │   ├── controller/        # REST endpoints (Admin + Public)
│   │   ├── dto/              # Data Transfer Objects
│   │   ├── entity/           # JPA сущности (News, User, Term, Role)
│   │   ├── exception/        # Пользовательские исключения + глобальный обработчик
│   │   ├── filter/           # Фильтр ограничения запросов
│   │   ├── mapper/           # Маппинг Entity-DTO
│   │   ├── repository/       # JPA репозитории
│   │   └── service/          # Бизнес-логика
│   ├── src/main/resources/
│   │   ├── db/migration/     # Spring Boot миграции
│   │   ├── application*.yml  # Конфигурации окружений
│   │   └── static/           # Статические ресурсы
│   └── src/test/             # Unit + интеграционные тесты
├── frontend/                  # Референсное Angular UI (опционально)
├── docs/                     # Документация (английская и русская)
├── .github/workflows/        # CI/CD пайплайны
├── docker-compose.yml        # Среда разработки
└── README.md                 # Документация проекта
```

## Основные сущности и схема базы данных

### News (таблица content)
- **Поля**: id, title, body, teaser, publicationDate, published, createdAt, updatedAt
- **Связи**: ManyToOne → User (автор), ManyToMany → Term (категории/теги)
- **Индексы**: title, published, publication_date

### User (таблица users)
- **Поля**: id, username, email, password, active
- **Связи**: OneToMany → News, ManyToMany → Role
- **Безопасность**: BCrypt пароли, система разрешений

### Term (таблица terms)
- **Поля**: id, name, vocabulary (группировка категория/тег)
- **Связи**: ManyToMany → News
- **Ограничения**: Unique(name, vocabulary)

### Role (таблица roles)
- **Поля**: id, name, description
- **Связи**: ManyToMany → User, ManyToMany → Permission

### Permission (таблица permissions)
- **Поля**: id, name
- **Система**: Детализированные разрешения (news:read, users:create, и т.д.)

## Headless API Endpoints

### Public Content API (`/api/public/news`) - Ограничение: 100 запросов/мин на IP
- `GET /` - Поиск опубликованных новостей (пагинация, фильтры)
- `GET /{id}` - Получить опубликованную статью по ID
- `GET /term/{termId}` - Получить новости по конкретному term ID (пагинация)
- `GET /terms?termIds=1,3,5` - Получить новости по нескольким term ID (пагинация)

### Content Management API (`/api/admin/news`)  
Требует роль ADMIN, Ограничение: 50 запросов/мин на IP
- `GET /` - Поиск всех новостей (опубликованные + неопубликованные)
- `POST /` - Создать новую статью
- `PUT /{id}` - Обновить существующую статью
- `DELETE /{id}` - Удалить статью

### Варианты использования Headless API
- **Пользовательские Frontend**: Создание с React, Vue, Angular или любым фреймворком
- **Мобильные приложения**: Нативные iOS/Android приложения
- **Интеграции с третьими сторонами**: Telegram боты, email рассылки
- **Мультиплатформенная публикация**: Веб-сайты, AMP страницы, социальные сети
- **Аналитика и реклама**: Подключение к внешним сервисам

### Поддержка пагинации
- **Параметры**: `page=0&size=10&sort=publicationDate,desc`
- **Настраиваемые размеры страниц**: 10, 15, 20+ статей на страницу
- **Сортировка**: По дате публикации (сначала новые) или любому полю
- **Формат ответа**: JSON с `content`, `totalElements`, `totalPages`, `size`

## Профили конфигурации

### application.yml (по умолчанию)
- Базовая конфигурация
- Заполнители переменных окружения

### application-local.yml
- Локальная разработка с H2 базой данных
- Отладочные настройки
- Автоматическое создание схемы

### application-prod.yml
- Конфигурация MySQL для продакшена
- Учетные данные на основе окружения
- Оптимизированные настройки JPA

### application-ci.yml
- База данных H2 в памяти
- Быстрое выполнение тестов
- Минимальное логирование

### application-test.yml
- H2 с режимом совместимости MySQL
- Тестовая конфигурация безопасности
- Поддержка переопределения бинов

## Конфигурация безопасности

### Основная безопасность (SecurityConfig)
- **Аутентификация**: HTTP Basic Auth
- **Авторизация**: На основе ролей (`/api/admin/**` требует ADMIN)
- **CSRF**: Отключен (REST API)
- **Система разрешений**: Детализированный контроль доступа

### Тестовая безопасность (TestSecurityConfig)
- **Переопределение**: Использует `@Primary` для замены основной конфигурации в тестах
- **Разрешения**: Все запросы разрешены
- **Учетные данные**: Тестовый пользователь администратор

## Сборка и CI/CD

### Gradle задачи
- `./gradlew build` - Полная сборка с тестами
- `./gradlew test` - Запуск тестов
- `./gradlew jacocoTestReport` - Генерация отчета покрытия
- `./gradlew checkstyleMain` - Валидация стиля кода

### GitHub Actions (gradle-ci.yml)
- **Триггеры**: Push в main, Pull Requests
- **Java**: OpenJDK 21
- **Шаги**: Сборка → Тесты → Покрытие → Статический анализ
- **Безопасность**: GitLeaks сканирование секретов
- **Артефакты**: Отчеты тестов, данные покрытия

## Качество кода
- **Checkstyle**: Лимит 120 символов в строке, Java конвенции
- **PMD**: Статический анализ кода
- **JaCoCo**: Отчеты покрытия тестами
- **CodeCov**: Интеграция отслеживания покрытия

## Конфигурация Docker

### Разработка (docker-compose.yml)
- **MySQL 8.0**: Порт 3306, постоянный том
- **Spring Boot**: Порт 8080, авто-перезапуск
- **Окружение**: Использует файл .env.dev

### База данных
- **Схема**: Автоматически создается Spring Boot миграциями
- **Данные**: Примеры данных через миграцию V3
- **Кодировка**: utf8mb4 для полной поддержки Unicode

## Миграция с Drupal 6

### Завершено
- **Маппинг схемы**: Drupal nodes → News сущности
- **Миграция пользователей**: Drupal users → Spring Security users
- **Таксономия**: Drupal terms → Term сущности с сохранением vocabulary
- **Контент**: Статьи с категориями и авторами

### Система словарей и обработка архивных данных

**Исходная структура Drupal 6:**
- Таблица `vocabulary` - определения словарей (категории, теги и т.д.)
- Таблица `term_data` - термины, связанные со словарями через `vid` (vocabulary ID)
- Таблица `term_node` - связи терминов с нодами (статьями)

**Процесс миграции:**
```sql
INSERT INTO terms (id, name, vocabulary)
SELECT td.tid, td.name, v.name
FROM a264971_dniester.term_data td
LEFT JOIN a264971_dniester.vocabulary v ON td.vid = v.vid;
```

**Что происходит с архивными терминами:**

1. **Все термины из Drupal 6 ИМЕЛИ словари** - они мигрируют корректно с исходными именами vocabulary
2. **Термины без словаря получают `vocabulary = NULL`** (если LEFT JOIN не находит соответствие, редкий случай)
3. **Связи терминов с новостями сохраняются** через таблицу `content_terms`
4. **Архивные новостные статьи сохраняют все свои исходные классификации**

**Два сценария базы данных:**

**Сценарий A: Миграция с Drupal 6**
- ✅ Все архивные термины имеют vocabulary из исходной структуры Drupal 6
- ✅ Имена словарей типа "category", "tags", "topics" сохраняются
- ✅ Все связи новости-термин поддерживаются
- ✅ Новый контент может использовать существующие термины или создавать новые

**Сценарий B: Чистая база данных (Новая установка)**
- ✅ Миграции Spring Boot (V1-V6) создают базовую структуру
- ✅ Миграция V3 создает пример термина: "General" с vocabulary "category"
- ✅ Новые термины могут создаваться с любой группировкой vocabulary
- ✅ Система поддерживает гибкое расширение таксономии

**Результат:** Система vocabulary корректно отражает архитектуру Drupal 6 и обеспечивает:
- Полное сохранение архивных данных
- Гибкую группировку терминов по типам (категории, теги, темы)
- Бесшовное расширение системы таксономии

### Стратегия ID сущностей
- **Автогенерация**: `@GeneratedValue(IDENTITY)` для новых записей
- **Совместимость миграции**: Может обрабатывать явные ID при необходимости

## Стратегия тестирования

### Unit тесты
- **Мапперы**: Конвертация Entity ↔ DTO
- **Сервисы**: Валидация бизнес-логики
- **Контроллеры**: Поведение endpoints

### Интеграционные тесты
- **База данных**: H2 в памяти с режимом MySQL
- **Безопасность**: Изолированная тестовая конфигурация
- **Транзакции**: `@Transactional` для очистки

### Тестовая конфигурация
- **Профили**: Отдельный тестовый профиль с H2
- **Безопасность**: Переопределена с разрешающей конфигурацией
- **Данные**: Автогенерируемые тестовые сущности

## Текущий статус и дорожная карта

### ✅ Завершено (Headless ядро)
- **Headless API**: Полный REST API с документацией OpenAPI/Swagger
- **Backend ядро**: Spring Boot 3.x с Java 21
- **База данных**: MySQL 8.0 с H2 для тестов
- **Безопасность**: Spring Security с системой разрешений
- **Управление контентом**: Полные CRUD операции через API
- **Пагинация**: Продвинутая фильтрация и поддержка пагинации
- **Кэширование**: Высокопроизводительное кэширование в памяти с Caffeine
- **Ограничение запросов**: IP-based защита API с Bucket4j
- **CI/CD**: GitHub Actions с автоматизированным тестированием
- **Docker**: Среда разработки с Docker Compose
- **Миграция**: Инструменты миграции Drupal 6 → Headless CMS
- **Open Source**: MIT лицензия для использования сообществом
- **Качество кода**: Устранено дублирование в мапперах с BaseMapper
- **Обработка ошибок**: Консистентная система исключений с кодами ошибок

### 🚧 В процессе
- **Документация**: Руководства по интеграции Headless API
- **Референсный Frontend**: Реализация Angular
- **Производительность**: Оптимизация API для высоконагруженных сценариев

### 🎯 Планируется
- **Аутентификация**: OAuth 2.0 + JWT для современной аутентификации
- **Продвинутые функции**: Загрузка файлов, продвинутый поиск, webhooks
- **Интеграции**: Коннекторы сторонних сервисов
- **Развертывание**: Руководства по cloud-native развертыванию
- **Сообщество**: Система плагинов для расширений

## Известные проблемы и технический долг

### ✅ Решено
- ~~Дублирование кода в мапперах~~ → Реализован BaseMapper
- ~~Отсутствие системы разрешений~~ → Добавлена система permissions с V5/V6 миграциями
- ~~Неконсистентная обработка ошибок~~ → Глобальный обработчик исключений
- ~~Отсутствие документации по миграции БД~~ → Подробные руководства по миграции
- ~~Неясность паролей CMS vs MySQL~~ → Документация обновлена

### 🔄 В работе
- **Референсный Angular Frontend**: Базовая структура создана, требует реализации компонентов
- **Производительность API**: Оптимизация запросов для высоконагруженных сценариев

### 🎯 Технический долг на будущее

#### Безопасность (Высокий приоритет)
- **OAuth 2.0 + JWT**: Замена Basic Auth на современную аутентификацию
- **2FA для ADMIN/EDITOR**: Двухфакторная аутентификация для критических ролей
- **CORS для продакшена**: Настройка для мультидоменных frontend
- **Rate Limiting по пользователям**: Дополнение к IP-based ограничениям

#### Функциональность (Средний приоритет)
- **Загрузка файлов**: Поддержка изображений и медиа для статей
- **Продвинутый поиск**: Full-text search с Elasticsearch/Lucene
- **Webhooks**: Уведомления о событиях для интеграций
- **Версионирование контента**: История изменений статей
- **Планировщик публикаций**: Отложенная публикация статей

#### Производительность (Средний приоритет)
- **Кэширование запросов**: Redis для распределенного кэша
- **Оптимизация БД**: Индексы для сложных запросов
- **Пагинация курсорами**: Для очень больших наборов данных
- **CDN интеграция**: Для статических ресурсов

#### DevOps (Низкий приоритет)
- **Kubernetes манифесты**: Для cloud-native развертывания
- **Мониторинг**: Prometheus + Grafana метрики
- **Логирование**: Structured logging с ELK stack
- **Backup автоматизация**: Регулярные бэкапы БД

## Переменные окружения

### Требуется для продакшена
```bash
# База данных
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/newsdb
SPRING_DATASOURCE_USERNAME=newsuser
SPRING_DATASOURCE_PASSWORD=secure_password

# Учетные данные администратора
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure_admin_password

# Сервер
SPRING_SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod
```

### Разработка (.env.dev)
```bash
# Пример переменных окружения для разработки
# Фактические значения в .env.dev (исключен из git)
MYSQL_ROOT_PASSWORD=<dev_password>
MYSQL_DATABASE=newsdb
MYSQL_USER=<dev_user>
MYSQL_PASSWORD=<dev_password>
ADMIN_USERNAME=<dev_admin>
ADMIN_PASSWORD=<dev_admin_password>
```

## Ключевые проектные решения

1. **Гибридная Headless архитектура**: API-first с опциональным референсным frontend
2. **Open Source**: MIT лицензия для принятия и вклада сообщества
3. **Медиа-ориентированность**: Разработано специально для новостных агентств и цифровых медиа
4. **API-First**: Вся функциональность доступна через REST endpoints
5. **Без привязки к поставщику**: Свобода выбора любой frontend технологии
6. **Профессиональный уровень**: Готовая к предприятию безопасность, кэширование и ограничение запросов
7. **Дружелюбность к миграции**: Инструменты для миграции с устаревших CMS платформ
8. **Docker First**: Контейнеризованная разработка и развертывание
9. **Современный стек**: Java 21, Spring Boot 3.x, MySQL 8.0
10. **Управляемость сообществом**: Расширяемая архитектура для плагинов и интеграций

## Целевая аудитория

### Профессиональные редакционные команды
- Новостные агентства, требующие пользовательские frontend решения
- Компании цифровых медиа с существующими мобильными приложениями
- Организации, нуждающиеся в мультиплатформенном распространении контента
- Команды, требующие интеграции с аналитическими и рекламными платформами

### Малые медиа организации
- Местные газеты, нуждающиеся в быстром развертывании
- Стартапы, требующие экономически эффективные CMS решения
- Организации, мигрирующие с устаревших платформ типа Drupal
- Команды, желающие начать с референсной реализации и настроить позже

Этот документ предоставляет полный контекст для понимания headless архитектуры Phoebe CMS, текущих возможностей и видения современного управления медиа контентом.