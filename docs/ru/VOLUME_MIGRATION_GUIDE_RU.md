> [Вернуться к содержанию документации](./README.md)

# Руководство по переносу Docker Volume с данными MySQL

Это руководство описывает процесс переноса Docker Volume с данными MySQL (база данных `phoebe_db`) с одной рабочей машины на другую, а также шаги по восстановлению данных. Это полезно при смене компьютера, восстановлении после сбоя или синхронизации рабочих сред.

---

## Концепция переноса

Перенос данных Docker Volume включает в себя следующие этапы:

1.  **Экспорт данных** с исходной машины (создание дампа базы данных).
2.  **Перенос дампа и кодовой базы** на целевую машину.
3.  **Импорт данных** на целевой машине.

---

## Часть 1: На исходной машине (Экспорт данных)

Эти шаги выполняются на компьютере, с которого вы хотите перенести данные.

### Шаг 1: Подготовка и создание дампа базы данных

Убедитесь, что все текущие изменения в проекте закоммичены и отправлены на GitHub.

1.  **Остановите все сервисы Docker Compose** для проекта Phoebe:
    ```bash
    docker compose down
    ```

2.  **Запустите только контейнер MySQL** для проекта Phoebe:
    ```bash
    docker compose up -d phoebe-mysql
    ```

3.  **Дождитесь готовности MySQL**. Это может занять несколько секунд:
    ```bash
    timeout 60s bash -c 'until docker exec phoebe-mysql mysqladmin ping -h localhost --silent; do sleep 2; done'
    ```

4.  **Создайте дамп базы данных `phoebe_db`**. Дамп будет сохранен в папке `db_dumps/` в корне проекта. Если папки нет, создайте ее:
    ```bash
    mkdir -p db_dumps
    docker exec phoebe-mysql mysqldump -uroot -proot phoebe_db > db_dumps/phoebe_db_backup_$(date +%Y%m%d_%H%M%S).sql
    ```
    *   **Примечание**: Используйте `phoebe_db` в команде `mysqldump`, чтобы создать дамп только этой базы данных. Если вы хотите сделать дамп всех баз данных, используйте `--all-databases` вместо `phoebe_db`.

5.  **Остановите контейнер MySQL**:
    ```bash
    docker compose down
    ```

### Шаг 2: Подготовка кодовой базы и дампа к переносу

1.  **Убедитесь, что ваш файл `.gitignore` актуален**. Он должен включать `db_dumps/` чтобы дампы не попадали в Git.
2.  **Скопируйте созданный дамп базы данных** (`db_dumps/phoebe_db_backup_*.sql`) в безопасное место, которое будет перенесено на целевую машину (например, на внешний диск, в облачное хранилище или через `scp`).
3.  **Убедитесь, что вся кодовая база проекта синхронизирована с Git-репозиторием**.

---

## Часть 2: На целевой машине (Импорт данных)

Эти шаги выполняются на компьютере, на который вы хотите перенести данные.

### Шаг 3: Клонирование проекта и подготовка

1.  **Клонируйте репозиторий проекта Phoebe** на целевую машину (если он еще не клонирован):
    ```bash
    git clone <URL_вашего_репозитория>
    cd phoebe
    ```

2.  **Убедитесь, что скрипт `gradlew` исполняемый**:
    ```bash
    chmod +x gradlew
    ```

3.  **Создайте папку `db_dumps/`** в корне проекта, если ее нет:
    ```bash
    mkdir -p db_dumps
    ```

4.  **Поместите файл дампа базы данных** (`phoebe_db_backup_*.sql`), созданный на Шаге 1, в папку `db_dumps/` на целевой машине.

### Шаг 4: Запуск MySQL и импорт данных

1.  **Запустите только контейнер MySQL** для проекта Phoebe:
    ```bash
    docker compose up -d phoebe-mysql
    ```

2.  **Дождитесь готовности MySQL**:
    ```bash
    timeout 60s bash -c 'until docker exec phoebe-mysql mysqladmin ping -h localhost --silent; do sleep 2; done'
    ```

3.  **Создайте базу данных `phoebe_db`** внутри контейнера MySQL, если она еще не существует:
    ```bash
    docker exec -it phoebe-mysql mysql -uroot -proot -e "CREATE DATABASE IF NOT EXISTS phoebe_db;"
    ```

4.  **Импортируйте данные из дампа** в базу данных `phoebe_db`:
    ```bash
    # Замените 'phoebe_db_backup_YYYYMMDD_HHMMSS.sql' на актуальное имя вашего файла дампа
    docker exec -i phoebe-mysql mysql -uroot -proot phoebe_db < db_dumps/phoebe_db_backup_YYYYMMDD_HHMMSS.sql
    ```

5.  **Остановите контейнер MySQL** (он будет перезапущен вместе со всеми сервисами на следующем шаге):
    ```bash
    docker compose down
    ```

### Шаг 5: Запуск проекта и верификация

1.  **Запустите все сервисы Docker Compose** для проекта Phoebe:
    ```bash
    docker compose up -d
    ```

2.  **Проверьте статус запущенных контейнеров**:
    ```bash
    docker ps
    ```

3.  **Проверьте подключение приложения к базе данных** (например, через Health Check):
    ```bash
    curl http://localhost:8080/actuator/health
    ```

4.  **Проверьте целостность данных** в базе данных `phoebe_db`:
    ```bash
    docker exec phoebe-mysql mysql -uroot -proot -e "SELECT COUNT(*) FROM phoebe_db.content;"
    ```

Теперь ваша рабочая среда Phoebe CMS с данными MySQL успешно перенесена и готова к работе на целевой машине.

---

## План отката (если что-то пошло не так)

Если в процессе импорта данных возникли проблемы, вы можете откатиться к чистому состоянию:

1.  **Остановите все сервисы Docker Compose**:
    ```bash
    docker compose down
    ```

2.  **Удалите Docker Volume, связанный с MySQL**, чтобы начать с чистого листа. **ВНИМАНИЕ: это удалит все данные в этом Volume!**
    ```bash
    docker volume rm phoebe_mysql_data # Убедитесь, что это правильное имя Volume
    ```

3.  **Удалите созданную базу данных `phoebe_db`** (если она была создана, но импорт не удался):
    ```bash
    docker exec -it phoebe-mysql mysql -uroot -proot -e "DROP DATABASE IF EXISTS phoebe_db;"
    ```

После этого вы можете повторить процесс импорта данных с Шага 3.

---

## Очистка (после успешного переноса)

После успешного переноса вы можете удалить файл дампа базы данных, если он больше не нужен:

```bash
rm db_dumps/phoebe_db_backup_YYYYMMDD_HHMMSS.sql
```
*   **Примечание**: Замените `phoebe_db_backup_YYYYMMDD_HHMMSS.sql` на актуальное имя вашего файла дампа.
