# Руководство по миграции: Drupal 6 → Phoebe CMS

Это подробное пошаговое руководство описывает процесс миграции контента с устаревшей
системы Drupal 6 на современную headless-архитектуру Phoebe CMS с использованием Docker и MySQL.

## Содержание
- [Общая схема процесса](#общая-схема-процесса)
- [Краткая версия (TL;DR)](#краткая-версия-tldr)
- [Полное руководство по миграции](#полное-руководство-по-миграции)
- [Описание структуры данных после миграции](#описание-структуры-данных-после-миграции)
- [Устранение неполадок](#устранение-неполадок)

---

## Общая схема процесса

Процесс миграции построен на принципе "извлечь, преобразовать, загрузить" (ETL)
и выглядит следующим образом:

1.  **Запуск временной среды**: Мы запускаем контейнер с MySQL 5.7, совместимый с дампом Drupal 6.
2.  **Импорт и нормализация**: Загружаем исходный дамп и применяем SQL-скрипты для очистки данных и
    приведения их к новой, современной схеме.
3.  **Экспорт чистого дампа**: Создаем финальный SQL-файл (`clean_schema.sql`), содержащий готовую
    структуру и данные.
4.  **Развертывание целевой среды**: Запускаем основной контейнер с MySQL 8.0.
5.  **Финальный импорт**: Загружаем `clean_schema.sql` в новую базу данных.

---

## Краткая версия (TL;DR)

Этот раздел для тех, у кого уже есть готовый файл `clean_schema.sql`.

```bash
# 1. Запустите контейнер с целевой базой данных MySQL 8.0
docker compose -f docker-compose.yml up -d mysql

# 2. Импортируйте очищенную схему и данные в базу 'dniester'
docker exec -i news-mysql mysql -uroot -proot dniester < db_data/clean_schema.sql

# 3. Убедитесь, что данные на месте (например, проверьте количество статей)
docker exec -it news-mysql mysql -uroot -proot -e "SELECT COUNT(*) FROM content;" dniester
```

---

## Полное руководство по миграции

### Шаг 1: Запуск временного MySQL 5.7 для дампа Drupal 6

Дампы старых версий Drupal могут быть несовместимы с последними версиями MySQL из-за синтаксических
различий. Поэтому мы используем временный контейнер с MySQL 5.7, который гарантирует совместимость.

```bash
# Запускаем контейнер в фоновом режиме. Файл docker-compose.drupal.yml специально
# настроен для этой задачи.
docker compose -f docker-compose.drupal.yml up -d

# Наблюдаем за логами, чтобы убедиться, что сервер успешно стартовал
docker logs -f news-mysql-drupal6
```

### Шаг 2: Импорт и нормализация данных

Теперь мы загружаем исходный дамп Drupal в нашу временную базу данных и применяем SQL-скрипты для его
преобразования.

```bash
# Импортируем исходный дамп (например, drupal6_fixed.sql) в базу данных 'dniester'
# внутри нашего временного контейнера.
docker exec -i news-mysql-drupal6 mysql -uroot -proot dniester < db_data/drupal6_fixed.sql

# Применяем основной скрипт нормализации. Он создает новые таблицы и переносит в них
# очищенные данные из старых таблиц Drupal.
docker exec -i news-mysql-drupal6 mysql -uroot -proot dniester < db_data/migrate_from_drupal6_universal.sql

# Если в вашем Drupal-сайте использовался модуль CCK для создания кастомных полей,
# примените этот дополнительный скрипт для их миграции.
docker exec -i news-mysql-drupal6 mysql -uroot -proot dniester < db_data/migrate_cck_fields.sql
```

### Шаг 3: Экспорт очищенной схемы (`clean_schema.sql`)

После того как все данные преобразованы, мы создаем финальный, "чистый" дамп. Этот файл является главным
артефактом всего процесса миграции.

```bash
# Создаем дамп базы 'dniester' из временного контейнера и сохраняем его в файл.
docker exec -i news-mysql-drupal6 mysqldump -uroot -proot dniester > db_data/clean_schema.sql
```

### Шаг 4: Подготовка и запуск целевой среды (MySQL 8.0)

Временная среда нам больше не нужна. Мы останавливаем ее и запускаем основную базу данных проекта.

```bash
# Останавливаем и полностью удаляем временный контейнер и его том.
docker compose -f docker-compose.drupal.yml down -v

# Запускаем основной контейнер с MySQL 8.0, который будет использоваться приложением.
docker compose -f docker-compose.yml up -d mysql
```

### Шаг 5: Импорт финального дампа в MySQL 8.0

Загружаем наш `clean_schema.sql` в новую, основную базу данных.

```bash
docker exec -i news-mysql mysql -uroot -proot dniester < db_data/clean_schema.sql
```

### Шаг 6: Проверка результата

Финальный шаг — убедиться, что все данные были успешно перенесены в новую базу данных.

```bash
# Проверяем количество статей в таблице content
docker exec -it news-mysql mysql -uroot -proot -e "SELECT COUNT(*) FROM content;" dniester

# Проверяем количество пользователей
docker exec -it news-mysql mysql -uroot -proot -e "SELECT COUNT(*) FROM users;" dniester
```

---

## Описание структуры данных после миграции

После выполнения скриптов нормализации, данные из Drupal 6 будут преобразованы в новую,
более структурированную схему.

- **Пользователи (`users`)**: Основная информация о пользователях (логин, email, статус).
- **Роли (`roles`)**: Роли, такие как ADMIN, EDITOR.
- **Контент (`content`)**: Все типы контента (статьи, страницы, книги) объединены в одну таблицу.
- **Таксономия (`terms`)**: Термины (категории, теги) с сохранением исходных словарей (`vocabulary`).
- **Связующие таблицы**: `user_roles`, `content_terms`, `role_permissions` для управления связями.

> Для получения полного описания финальной схемы, обратитесь к [Руководству по базе данных](./DATABASE_GUIDE_RU.md).

---

## Устранение неполадок

### Проблемы с кодировкой (UTF-8)
Если при импорте возникают ошибки вида `Incorrect string value`, это означает, что ваша база данных
использует неверную кодировку по умолчанию (например, `latin1`). Убедитесь, что все таблицы создаются
с кодировкой `utf8mb4`.

### Проблемы с паролем root в MySQL 8.0
Иногда после инициализации контейнера могут возникнуть проблемы с аутентификацией пользователя `root`.
В этом случае может потребоваться ручной сброс пароля с использованием флага `--skip-grant-tables`.
Подробные инструкции можно найти в англоязычной документации или в [Руководстве по установке](./SETUP_GUIDE_RU.md).
