# Полная информация о проекте

## Обзор проекта
**Название**: Dniester — Headless CMS для новостных агентств и цифровых медиа  
**Тип**: Open Source Headless система управления контентом (гибридная архитектура)  
**Миграция**: Drupal 6 → Современный Headless Spring Boot + Опциональный Angular Frontend  
**Статус**: Headless Backend готов к продакшену, Референсный Frontend планируется  
**Лицензия**: MIT (Open Source)

## Технологический стек

### Headless Backend (Готов к продакшену)
- **Фреймворк**: Spring Boot 3.x
- **Язык**: Java 21
- **База данных**: MySQL 8.0 (H2 для тестов)
- **Безопасность**: Spring Security с настраиваемой аутентификацией
- **API**: REST с документацией OpenAPI/Swagger
- **Кэширование**: Caffeine (In-Memory)
- **Сборка**: Gradle 8.7
- **Тестирование**: JUnit 5, интеграционные тесты с H2
- **Миграция**: Flyway (отключен в пользу Hibernate DDL)

### Референсный Frontend (Опциональный)
- **Фреймворк**: Angular с Angular Universal
- **Назначение**: Референсная реализация для малых медиа организаций
- **Дизайн**: Адаптивный макет в стиле Google News
- **SEO**: Статические URL, SSR, JSON-LD, OpenGraph метаданные
- **Брендинг**: Настраиваемая система тем
- **Функции**: Поиск, темная тема, push-уведомления (планируется)
- **Примечание**: Профессиональные команды могут создавать собственные frontend используя headless API

### Инфраструктура
- **Контейнеризация**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **Качество кода**: Checkstyle, JaCoCo coverage
- **База данных**: MySQL с Docker
- **Ограничение запросов**: Bucket4j с IP-based buckets

## Гибридная Headless архитектура

**Dniester** следует **гибридному Headless** подходу, обеспечивая максимальную гибкость:

- **Headless ядро**: Полный REST API для разработки пользовательских frontend
- **Референсный Frontend**: Опциональное Angular приложение для быстрого развертывания
- **API-First**: Вся функциональность доступна через REST endpoints
- **Без привязки к поставщику**: Используйте наш frontend или создайте свой

## Структура проекта
```
dniester/
├── backend/                    # Headless Spring Boot API
│   ├── src/main/java/com/example/newsplatform/
│   │   ├── config/            # Конфигурации безопасности, тестов, ограничений, кэша
│   │   ├── controller/        # REST endpoints (Admin + Public)
│   │   ├── dto/              # Data Transfer Objects
│   │   ├── entity/           # JPA сущности (News, User, Term, Role)
│   │   ├── exception/        # Пользовательские исключения + глобальный обработчик
│   │   ├── filter/           # Фильтр ограничения запросов
│   │   ├── mapper/           # Маппинг Entity-DTO
│   │   ├── repository/       # JPA репозитории
│   │   └── service/          # Бизнес-логика
│   ├── src/main/resources/
│   │   ├── db/migration/     # Flyway SQL скрипты
│   │   ├── application*.yml  # Конфигурации окружений
│   │   └── static/           # Статические ресурсы
│   └── src/test/             # Unit + интеграционные тесты
├── frontend/                  # Референсное Angular UI (опционально)
├── docs/                     # Английская документация
├── docsru/                   # Русская документация
├── .github/workflows/        # CI/CD пайплайны
├── docker-compose.yml        # Среда разработки
└── README.md                 # Документация проекта
```

## Основные сущности и схема базы данных

### News (таблица content)
- **Поля**: id, title, body, teaser, publicationDate, published, createdAt, updatedAt
- **Связи**: ManyToOne → User (автор), ManyToMany → Term (категории/теги)
- **Индексы**: title, published, publication_date

### User (таблица users)
- **Поля**: id, username, email, active
- **Связи**: OneToMany → News, ManyToMany → Role
- **Безопасность**: Basic Auth с BCrypt паролями

### Term (таблица terms)
- **Поля**: id, name, vocabulary (группировка категория/тег)
- **Связи**: ManyToMany → News
- **Ограничения**: Unique(name, vocabulary)

### Role (таблица roles)
- **Поля**: id, name
- **Связи**: ManyToMany → User

## Headless API Endpoints

### Public Content API (`/api/public/news`) - Ограничение: 100 запросов/мин на IP
- `GET /` - Поиск опубликованных новостей (пагинация, фильтры)
- `GET /{id}` - Получить опубликованную статью по ID
- `GET /term/{termId}` - Получить новости по конкретному term ID (пагинация)
- `GET /terms?termIds=1,3,5` - Получить новости по нескольким term ID (пагинация)

### Content Management API (`/api/admin/news`) - Требует роль ADMIN, Ограничение: 50 запросов/мин на IP
- `GET /` - Поиск всех новостей (опубликованные + неопубликованные)
- `POST /` - Создать новую статью
- `PUT /{id}` - Обновить существующую статью
- `DELETE /{id}` - Удалить статью

### Варианты использования Headless API
- **Пользовательские Frontend**: Создание с React, Vue, Angular или любым фреймворком
- **Мобильные приложения**: Нативные iOS/Android приложения
- **Интеграции с третьими сторонами**: Telegram боты, email рассылки
- **Мультиплатформенная публикация**: Веб-сайты, AMP страницы, социальные сети
- **Аналитика и реклама**: Подключение к внешним сервисам

### Поддержка пагинации
- **Параметры**: `page=0&size=10&sort=publicationDate,desc`
- **Настраиваемые размеры страниц**: 10, 15, 20+ статей на страницу
- **Сортировка**: По дате публикации (сначала новые) или любому полю
- **Формат ответа**: JSON с `content`, `totalElements`, `totalPages`, `size`

## Профили конфигурации

### application.yml (по умолчанию)
- Базовая конфигурация
- Заполнители переменных окружения

### application-prod.yml
- Конфигурация MySQL для продакшена
- Учетные данные на основе окружения
- Оптимизированные настройки JPA

### application-ci.yml
- База данных H2 в памяти
- Быстрое выполнение тестов
- Минимальное логирование

### application-test.yml
- H2 с режимом совместимости MySQL
- Тестовая конфигурация безопасности
- Поддержка переопределения бинов

## Конфигурация безопасности

### Основная безопасность (SecurityConfig)
- **Аутентификация**: HTTP Basic Auth
- **Авторизация**: На основе ролей (`/api/admin/**` требует ADMIN)
- **CSRF**: Отключен (REST API)
- **Управление пользователями**: В памяти с настраиваемыми учетными данными администратора

### Тестовая безопасность (TestSecurityConfig)
- **Переопределение**: Использует `@Primary` для замены основной конфигурации в тестах
- **Разрешения**: Все запросы разрешены
- **Учетные данные**: Тестовый пользователь администратор

## Сборка и CI/CD

### Gradle задачи
- `./gradlew build` - Полная сборка с тестами
- `./gradlew test` - Запуск тестов
- `./gradlew jacocoTestReport` - Генерация отчета покрытия
- `./gradlew checkstyleMain` - Валидация стиля кода

### GitHub Actions (gradle-ci.yml)
- **Триггеры**: Push в main, Pull Requests
- **Java**: OpenJDK 21
- **Шаги**: Сборка → Тесты → Покрытие → Статический анализ
- **Артефакты**: Отчеты тестов, данные покрытия

## Качество кода
- **Checkstyle**: Лимит 120 символов в строке, Java конвенции
- **JaCoCo**: Отчеты покрытия тестами
- **CodeCov**: Интеграция отслеживания покрытия

## Конфигурация Docker

### Разработка (docker-compose.yml)
- **MySQL 8.0**: Порт 3306, постоянный том
- **Spring Boot**: Порт 8080, авто-перезапуск
- **Окружение**: Использует файл .env.dev

### База данных
- **Схема**: Автоматически создается Hibernate (ddl-auto: update)
- **Данные**: Примеры данных через Flyway миграции
- **Кодировка**: utf8mb4 для полной поддержки Unicode

## Миграция с Drupal 6

### Завершено
- **Маппинг схемы**: Drupal nodes → News сущности
- **Миграция пользователей**: Drupal users → Spring Security users
- **Таксономия**: Drupal terms → Term сущности
- **Контент**: Статьи с категориями и авторами

### Стратегия ID сущностей
- **Автогенерация**: `@GeneratedValue(IDENTITY)` для новых записей
- **Совместимость миграции**: Может обрабатывать явные ID при необходимости

## Стратегия тестирования

### Unit тесты
- **Мапперы**: Конвертация Entity ↔ DTO
- **Сервисы**: Валидация бизнес-логики
- **Контроллеры**: Поведение endpoints

### Интеграционные тесты
- **База данных**: H2 в памяти с режимом MySQL
- **Безопасность**: Изолированная тестовая конфигурация
- **Транзакции**: `@Transactional` для очистки

### Тестовая конфигурация
- **Профили**: Отдельный тестовый профиль с H2
- **Безопасность**: Переопределена с разрешающей конфигурацией
- **Данные**: Автогенерируемые тестовые сущности

## Текущий статус и дорожная карта

### ✅ Завершено (Headless ядро)
- **Headless API**: Полный REST API с документацией OpenAPI/Swagger
- **Backend ядро**: Spring Boot 3.x с Java 21
- **База данных**: MySQL 8.0 с H2 для тестов
- **Безопасность**: Spring Security с настраиваемой аутентификацией
- **Управление контентом**: Полные CRUD операции через API
- **Пагинация**: Продвинутая фильтрация и поддержка пагинации
- **Кэширование**: Высокопроизводительное кэширование в памяти с Caffeine
- **Ограничение запросов**: IP-based защита API с Bucket4j
- **CI/CD**: GitHub Actions с автоматизированным тестированием
- **Docker**: Среда разработки с Docker Compose
- **Миграция**: Инструменты миграции Drupal 6 → Headless CMS
- **Open Source**: MIT лицензия для использования сообществом

### 🚧 В процессе
- **Документация**: Руководства по интеграции Headless API
- **Референсный Frontend**: Реализация Angular
- **Производительность**: Оптимизация API для высоконагруженных сценариев

### 🎯 Планируется
- **Аутентификация**: OAuth 2.0 + 2FA для повышенной безопасности
- **Продвинутые функции**: Загрузка файлов, продвинутый поиск, webhooks
- **Интеграции**: Коннекторы сторонних сервисов
- **Развертывание**: Руководства по cloud-native развертыванию
- **Сообщество**: Система плагинов для расширений

## Известные проблемы и технический долг

### Безопасность
- Конфигурация CORS нуждается в доработке для продакшена
- **Миграция OAuth 2.0 + 2FA планируется**: Замена Basic Auth на OAuth 2.0 и двухфакторную аутентификацию для ролей ADMIN и EDITOR
- Улучшения валидации и санитизации входных данных

### Производительность
- Необходима оптимизация запросов к базе данных
- Улучшения пагинации для больших наборов данных

### Качество кода
- Уменьшение дублирования кода в мапперах
- Улучшение консистентности обработки ошибок
- Добавление более комплексной валидации

## Переменные окружения

### Требуется для продакшена
```bash
# База данных
SPRING_DATASOURCE_URL=jdbc:mysql://localhost:3306/newsdb
SPRING_DATASOURCE_USERNAME=newsuser
SPRING_DATASOURCE_PASSWORD=secure_password

# Учетные данные администратора
ADMIN_USERNAME=admin
ADMIN_PASSWORD=secure_admin_password

# Сервер
SPRING_SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod
```

### Разработка (.env.dev)
```bash
# Пример переменных окружения для разработки
# Фактические значения в .env.dev (исключен из git)
MYSQL_ROOT_PASSWORD=<dev_password>
MYSQL_DATABASE=newsdb
MYSQL_USER=<dev_user>
MYSQL_PASSWORD=<dev_password>
ADMIN_USERNAME=<dev_admin>
ADMIN_PASSWORD=<dev_admin_password>
```

## Ключевые проектные решения

1. **Гибридная Headless архитектура**: API-first с опциональным референсным frontend
2. **Open Source**: MIT лицензия для принятия и вклада сообщества
3. **Медиа-ориентированность**: Разработано специально для новостных агентств и цифровых медиа
4. **API-First**: Вся функциональность доступна через REST endpoints
5. **Без привязки к поставщику**: Свобода выбора любой frontend технологии
6. **Профессиональный уровень**: Готовая к предприятию безопасность, кэширование и ограничение запросов
7. **Дружелюбность к миграции**: Инструменты для миграции с устаревших CMS платформ
8. **Docker First**: Контейнеризованная разработка и развертывание
9. **Современный стек**: Java 21, Spring Boot 3.x, MySQL 8.0
10. **Управляемость сообществом**: Расширяемая архитектура для плагинов и интеграций

## Целевая аудитория

### Профессиональные редакционные команды
- Новостные агентства, требующие пользовательские frontend решения
- Компании цифровых медиа с существующими мобильными приложениями
- Организации, нуждающиеся в мультиплатформенном распространении контента
- Команды, требующие интеграции с аналитическими и рекламными платформами

### Малые медиа организации
- Местные газеты, нуждающиеся в быстром развертывании
- Стартапы, требующие экономически эффективные CMS решения
- Организации, мигрирующие с устаревших платформ типа Drupal
- Команды, желающие начать с референсной реализации и настроить позже

Этот документ предоставляет полный контекст для понимания headless архитектуры Dniester, текущих возможностей и видения современного управления медиа контентом.