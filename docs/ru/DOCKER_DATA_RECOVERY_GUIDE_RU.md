# Руководство по резервному копированию и восстановлению данных Docker

Этот документ описывает полный процесс инвентаризации, резервного копирования (дампа) и восстановления
всех баз данных проекта, хранящихся в Docker-вольюмах. Это **первый шаг** в процессе полного переноса
проекта на другой компьютер.

> **Следующий шаг**: После создания резервных копий данных, обратитесь к
> **[Руководству по полному переносу проекта](./PROJECT_TRANSFER_GUIDE_RU.md)**
> для инструкций по переносу кодовой базы и развертыванию на новом месте.

---

## Часть 1: Анализ Docker-окружения

В процессе разработки в Docker могут накапливаться несколько контейнеров и вольюмов. Важно понимать,
какой из них за что отвечает.

### 1.1 Анализ проектов и их назначение

- **Проект `phoebe` (основной)**
  - **Контейнер**: `news-mysql` (MySQL 8.0)
  - **Вольюм**: `phoebe_mysql_data`
  - **Назначение**: Ваш основной, текущий проект. В нем работает Spring Boot приложение и используется
    современная база данных, в которую были мигрированы данные. Именно с ним ведется ежедневная работа.

- **Проект `legacy` (вспомогательный для миграции)**
  - **Контейнер**: `news-mysql-drupal6` (MySQL 5.7)
  - **Вольюм**: `news-platform_mysql_data_drupal6`
  - **Назначение**: Этот проект был создан только для одной цели — для процесса миграции. Старый дамп
    Drupal 6 требовал старой версии MySQL для совместимости. Окружение `legacy` является инструментом
    для воспроизведения миграции и не требуется для ежедневной работы. Его следует держать остановленным.

### 1.2 Инвентаризация вольюмов

Команда `docker volume ls` покажет все хранилища данных. На основе анализа выше, ключевыми являются:
- `phoebe_mysql_data` (актуальная БД)
- `news-platform_mysql_data_drupal6` (исходная БД для миграции)

---

## Часть 2: Восстановление исходной БД Drupal 6 из "потерянного" вольюма

Этот раздел описывает, как создать резервную копию самой первой базы данных Drupal 6, если вы
подозреваете, что она была утеряна, или если стандартный процесс миграции создает пустой дамп.
Это может произойти, если Docker Compose создает новый пустой том вместо подключения существующего.

### Шаг 2.1: Поиск точного имени вольюма

Чтобы быть на 100% уверенным, какой вольюм был привязан к вашему самому старому контейнеру, выполните:

```bash
docker inspect news-mysql-drupal6
```

В выводе найдите секцию `Mounts`. Поле `Name` укажет на точное имя вольюма, который вам нужен
(например, `news-platform_mysql_data_drupal6`).

### Шаг 2.2 (Опционально): Исследование вольюма

Чтобы убедиться, что в вольюме действительно есть данные, можно заглянуть внутрь с помощью временного
"контейнера-проводника". Замените `<имя_вольюма>` на имя, найденное на предыдущем шаге.

```bash
docker run --rm -it -v <имя_вольюма>:/data ubuntu:latest bash
```

Внутри контейнера выполните `cd /data` и `du -sh .`. Размер должен быть внушительным (например, >200MB).
После проверки выйдите из контейнера командой `exit`.

### Шаг 2.3: Создание дампа из правильного вольюма

Теперь, зная точное имя "золотого" вольюма, мы можем создать его полный дамп. Эта команда запускает
временный контейнер с MySQL 5.7, монтирует к нему ваш вольюм и выполняет `mysqldump`.

Замените `<имя_вольюма>` на ваше (например, `news-platform_mysql_data_drupal6`).

```bash
docker run --rm -v <имя_вольюма>:/var/lib/mysql -v $(pwd)/db_dumps:/backup mysql:5.7 \
sh -c 'mysqld --daemonize && sleep 30 && mysqldump -uroot -proot --all-databases > /backup/drupal6_migration_backup_FULL.sql'
```

- `mysqld --daemonize`: Запускает сервер MySQL в фоновом режиме внутри контейнера.
- `sleep 30`: Пауза в 30 секунд, чтобы дать серверу время полностью запуститься.
- `mysqldump ...`: Создает дамп всех баз данных и сохраняет его в файл `drupal6_migration_backup_FULL.sql`
  в вашей директории `db_dumps` на хост-машине.

После выполнения этой команды у вас будет полный и корректный бэкап вашей самой первой базы данных.

---

## Часть 3: Создание дампа актуальной БД проекта (MySQL 8.0)

**Важно**: Перед созданием дампа убедитесь, что основной контейнер `news-mysql` остановлен,
чтобы избежать ошибок блокировки файлов (`Unable to lock ./ibdata1`).

1. **Остановите контейнер**:
   ```bash
   docker stop news-mysql
   ```

2. **Создайте дамп**:
   ```bash
   docker run --rm -v phoebe_mysql_data:/var/lib/mysql -v $(pwd)/db_dumps:/backup mysql:8.0 \
   sh -c 'mysqld --daemonize && sleep 30 && mysqldump -uroot -proot --all-databases > /backup/phoebe_new_db_backup.sql'
   ```

3. **Перезапустите контейнер**:
   ```bash
   docker start news-mysql
   ```

- **Результат**: Файл `phoebe_new_db_backup.sql` с полным бэкапом актуальной БД.

---

## Часть 4: Перенос и восстановление на другом компьютере

После того как вы скопировали нужные `.sql` файлы на новый компьютер, вы можете восстановить любую из баз данных.

1. **Создайте и запустите нужный контейнер**: Например, для актуальной БД:
   ```bash
   docker compose up -d mysql
   ```

2. **Импортируйте дамп**:
   ```bash
   docker exec -i <имя_контейнера> mysql -uroot -proot < phoebe_new_db_backup.sql
   ```

Эта процедура гарантирует полный и безопасный перенос всей вашей работы.

---

## Часть 5: Глубокий анализ и инвентаризация окружения

Этот раздел предоставляет детальный анализ запущенных контейнеров и вольюмов, чтобы вы могли
точно понимать, с чем работаете.

### 5.1 Анализ запущенных проектов (`docker ps`)

Вывод `docker ps` показывает два запущенных "проекта", каждый со своим MySQL контейнером:

| Проект | Имя контейнера | Образ (Версия) | Назначение |
| :--- | :--- | :--- | :--- |
| **`legacy`** | `news-mysql-drupal6` | `mysql:5.7` | **Вспомогательный**. Для миграции со старого Drupal. |
| **`phoebe`** | `news-mysql` | `mysql:8.0` | **Основной**. Актуальная БД для вашего приложения. |

Для ежедневной работы вам **не нужно**, чтобы `legacy` (`news-mysql-drupal6`) был запущен. Его можно
безопасно остановить командой `docker compose -f legacy/docker-compose.drupal.yml down`.

### 5.2 Исследование баз данных

#### 5.2.1 Исследование старой БД (`legacy`)

1. **Подключитесь к контейнеру**:
   ```bash
   docker exec -it news-mysql-drupal6 mysql -uroot -proot
   ```
2. **Посмотрите базы данных**:
   ```sql
   SHOW DATABASES;
   ```
   Вы, скорее всего, увидите базу `a264971_dniester` (старое имя) и `dniester` (куда мы импортировали для очистки).

3. **Посмотрите старые таблицы Drupal**:
   ```sql
   USE a264971_dniester;
   SHOW TABLES;
   ```
   Вы увидите таблицы, такие как `node`, `node_revisions`, `term_data`, `users`.

#### 5.2.2 Исследование новой БД (`phoebe`)

1. **Подключитесь к контейнеру**:
   ```bash
   docker exec -it news-mysql mysql -uroot -proot
   ```
2. **Посмотрите таблицы**:
   ```sql
   USE dniester;
   SHOW TABLES;
   ```
   Вы увидите таблицы с новыми именами: `content`, `users`, `roles`, `permissions`, `terms`.

### 5.3 Финальный анализ Docker-вольюмов (по данным Docker Desktop)

| Имя вольюма | Размер | Статус | Назначение |
| :--- | :--- | :--- | :--- |
| **`phoebe_mysql_data`** | **201 MB** | **in use** | **Ваша новая, актуальная база данных (MySQL 8.0).** |
| **`news-platform_mysql_data_drupal6`** | **982.7 MB** | - | **"Золотой" архив. Самый первый, полный дамп Drupal 6.** |
| `news-platform_mysql_data` | 628.8 MB | - | Архив старого проекта. Менее важен, чем "золотой" архив. |
| `legacy_mysql_data_drupal6` | 210 MB | in use | Промежуточная база миграции. Можно удалить. |

### 5.4 Итог и рекомендации

- Для переноса на другой компьютер вам нужны в первую очередь два файла:
  - `phoebe_new_db_backup.sql` (ваша актуальная работа)
  - `drupal6_migration_backup_FULL.sql` (исторический архив)

- Вольюмы `news-platform_mysql_data` и `legacy_mysql_data_drupal6` можно удалить для освобождения места,
  так как их бэкапы у вас уже есть.
  ```bash
  docker volume rm legacy_mysql_data_drupal6
  docker volume rm news-platform_mysql_data
  ```
