# Руководство по резервному копированию и восстановлению данных Docker

Этот документ описывает полный процесс инвентаризации, резервного копирования (дампа) и восстановления
всех баз данных проекта, хранящихся в Docker-вольюмах. Это необходимо для переноса всей
работы на другой компьютер или для создания полных резервных копий.

---

## Часть 1: Восстановление исходной БД Drupal 6 из "потерянного" вольюма

Этот раздел описывает, как создать резервную копию самой первой базы данных Drupal 6, если вы
подозреваете, что она была утеряна, или если стандартный процесс миграции создает пустой дамп.
Это может произойти, если Docker Compose создает новый пустой том вместо подключения существующего.

### Контекст проблемы

После миграции в системе Docker могут остаться несколько вольюмов (хранилищ данных). Наша задача —
найти "золотой" вольюм, содержащий исходные данные Drupal 6, и безопасно извлечь их.

### Шаг 1.1: Инвентаризация всех Docker-вольюмов

Сначала получим список всех вольюмов, чтобы понять, что у нас есть.

```bash
docker volume ls
```

Вы увидите список, похожий на этот:
```
DRIVER    VOLUME NAME
local     legacy_mysql_data_drupal6
local     news-platform_mysql_data
local     news-platform_mysql_data_drupal6
local     phoebe_mysql_data
```

- `phoebe_mysql_data`: Вольюм вашего текущего проекта (MySQL 8.0).
- `legacy_mysql_data_drupal6`: Скорее всего, новый пустой вольюм, созданный недавним запуском.
- `news-platform_mysql_data_drupal6`: **Наиболее вероятный кандидат** на "золотой" вольюм с исходными данными.

### Шаг 1.2: Поиск точного имени вольюма

Чтобы быть на 100% уверенным, какой вольюм был привязан к вашему самому старому контейнеру, выполните:

```bash
docker inspect news-mysql-drupal6
```

В выводе найдите секцию `Mounts`. Поле `Name` укажет на точное имя вольюма, который вам нужен.

### Шаг 1.3 (Опционально): Исследование вольюма

Чтобы убедиться, что в вольюме действительно есть данные, можно заглянуть внутрь с помощью временного
"контейнера-проводника". Замените `<имя_вольюма>` на имя, найденное на предыдущем шаге.

```bash
docker run --rm -it -v <имя_вольюма>:/data ubuntu:latest bash
```

Внутри контейнера выполните `cd /data` и `du -sh .`. Размер должен быть внушительным (например, >200MB).
После проверки выйдите из контейнера командой `exit`.

### Шаг 1.4: Создание дампа из правильного вольюма

Теперь, зная точное имя "золотого" вольюма, мы можем создать его полный дамп. Эта команда запускает
временный контейнер с MySQL 5.7, монтирует к нему ваш вольюм и выполняет `mysqldump`.

Замените `<имя_вольюма>` на ваше (например, `news-platform_mysql_data_drupal6`).

```bash
docker run --rm -v <имя_вольюма>:/var/lib/mysql -v $(pwd):/backup mysql:5.7 \
sh -c 'mysqld --daemonize && sleep 30 && mysqldump -uroot -proot --all-databases > /backup/drupal6_migration_backup_FULL.sql'
```

- `mysqld --daemonize`: Запускает сервер MySQL в фоновом режиме внутри контейнера.
- `sleep 30`: Пауза в 30 секунд, чтобы дать серверу время полностью запуститься.
- `mysqldump ...`: Создает дамп всех баз данных и сохраняет его в файл `drupal6_migration_backup_FULL.sql`
  в вашей текущей директории на хост-машине.

После выполнения этой команды у вас будет полный и корректный бэкап вашей самой первой базы данных.

---

## Часть 2: Создание дампов для остальных вольюмов

Для полного переноса проекта необходимо также сделать бэкапы остальных баз данных.

### 2.1 Бэкап актуальной БД проекта (MySQL 8.0)

Эта команда создает дамп из вольюма вашего текущего проекта `phoebe`.

```bash
docker run --rm -v phoebe_mysql_data:/var/lib/mysql -v $(pwd):/backup mysql:8.0 \
sh -c 'mysqld --daemonize && sleep 30 && mysqldump -uroot -proot --all-databases > /backup/phoebe_new_db_backup.sql'
```

- **Результат**: Файл `phoebe_new_db_backup.sql` с полным бэкапом актуальной БД.

### 2.2 Бэкап старой БД `news-platform` (на всякий случай)

Эта команда создает дамп из вольюма старого проекта `news-platform`.

```bash
docker run --rm -v news-platform_mysql_data:/var/lib/mysql -v $(pwd):/backup mysql:8.0 \
sh -c 'mysqld --daemonize && sleep 30 && mysqldump -uroot -proot --all-databases > /backup/news_platform_db_backup.sql'
```

- **Результат**: Файл `news_platform_db_backup.sql`.

---

## Часть 3: Перенос и восстановление на другом компьютере

После того как вы скопировали все `.sql` файлы на новый компьютер, вы можете восстановить любую из баз данных.

1. **Создайте и запустите нужный контейнер**: Например, для актуальной БД:
   ```bash
   docker compose up -d mysql
   ```

2. **Импортируйте дамп**:
   ```bash
   docker exec -i <имя_контейнера> mysql -uroot -proot < phoebe_new_db_backup.sql
   ```

Эта процедура гарантирует полный и безопасный перенос всей вашей работы.
