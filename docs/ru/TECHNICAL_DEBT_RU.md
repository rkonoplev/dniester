# Технический долг и история улучшений

Этот документ отслеживает историю значимых улучшений, текущие задачи и будущие планы по развитию проекта.

---

## Завершенные задачи и архитектурные решения

Этот раздел служит журналом изменений, документируя ключевые реализованные возможности и рефакторинги,
основанные на анализе текущего состояния кодовой базы.

### Архитектура и Дизайн
- **Слоёная архитектура**: Реализовано четкое разделение на слои Controller, Service и Repository.
- **Принцип единой ответственности**: Логика разделена по доменным областям (новости, роли, авторизация).
- **DTO-паттерн**: Используются Data Transfer Objects для всех API-запросов и ответов, обеспечивая
  изоляцию внутренней модели.
- **Централизованная авторизация**: Логика проверки прав доступа вынесена в `AuthorizationService`.
- **Автоматическое маппинг**: Внедрен MapStruct для автоматического преобразования между DTO и сущностями.

### Безопасность
- **Аутентификация и авторизация**: Интегрирован Spring Security с базовой аутентификацией.
- **Ролевая модель (RBAC)**: Реализована система с ролями (ADMIN, EDITOR) и гранулярными разрешениями.
- **Защита эндпоинтов**: Административные API защищены и требуют соответствующих ролей.

### Производительность
- **Кэширование**: Внедрено кэширование на уровне методов (`@Cacheable`) с использованием Caffeine для
  часто запрашиваемых данных.
- **Ограничение частоты запросов (Rate Limiting)**: Реализована защита API от флуда с помощью Bucket4j.
- **Оптимизация транзакций**: Все методы сервисов, предназначенные только для чтения, аннотированы
  `@Transactional(readOnly = true)`.

### База данных
- **Доступ к данным**: Проект использует блокирующий стек **Spring Data JPA** для простоты и надежности.
- **Управление миграциями**: Схема базы данных управляется с помощью Flyway, обеспечивая версионирование.
- **Поддержка нескольких СУБД**: Архитектура поддерживает как MySQL, так и H2 (для тестов).

### Качество кода и CI/CD
- **Статический анализ**: Настроены и интегрированы Checkstyle и PMD для поддержания качества кода.
- **Тестовое покрытие**: Интегрирован JaCoCo для анализа покрытия кода тестами.
- **Рефакторинг тестовой структуры**: Проведено полное разделение тестов на юнит- и интеграционные
  (`unit/` и `integration/`).
- **Настройка Gradle**: `build.gradle` сконфигурирован для раздельного запуска юнит- и интеграционных тестов.
- **Интеграционные тесты**: Настроены для работы с docker-compose MySQL, используя профиль `local`
  с Hibernate `create-drop` для автоматического управления схемой.
- **Унификация тестовой архитектуры**: Создан единый `AbstractIntegrationTest` базовый класс
  для всех интеграционных тестов, устранено дублирование кода.

---

## В процессе

- **Производительность API**: Дальнейшая оптимизация запросов для сценариев с высоким трафиком.

---

## Будущие планы

Этот раздел описывает запланированные функции и улучшения, сгруппированные по приоритетам.

### Безопасность (Высокий приоритет)

#### 1. OAuth 2.0 + JWT — замена Basic Auth
- **Цель**: Перейти от устаревшей Basic Auth к современной, безопасной и масштабируемой аутентификации.
- **Что включает**:
  - Авторизация через OAuth 2.0 (например, Google, GitHub, собственный Identity Provider).
  - Генерация и валидация JWT-токенов.
  - Хранение ролей и прав доступа в токене или в базе.
  - Обновление механизма логина, защиты эндпоинтов, logout, refresh-токенов.
- **Когда внедрять**: После стабилизации бизнес-логики и API, но до публичного релиза.
- **Рекомендация**: Рекомендуется внедрять до деплоя на Render.com, чтобы не менять механику авторизации на проде.

#### 2. 2FA (двухфакторная аутентификация) для ADMIN/EDITOR
- **Цель**: Добавить дополнительный уровень защиты для критически важных ролей.
- **Что включает**:
  - Генерация временных кодов (TOTP, SMS, email).
  - Поддержка Google Authenticator или аналогов.
  - UI/UX для подтверждения второго фактора.
  - Хранение и проверка 2FA-секретов.
- **Когда внедрять**: После внедрения OAuth 2.0 + JWT, когда основная система авторизации уже безопасна и гибка.
- **Примечание**: Это надстройка, которая требует стабильной системы токенов и ролей.

### Рекомендуемый порядок действий

| Этап | Что делать | Почему |
| :---: | :--- | :--- |
| 1️⃣ | Завершить текущую бизнес-логику и API | Чтобы не мешать авторизации |
| 2️⃣ | Внедрить OAuth 2.0 + JWT | Основной механизм авторизации |
| 3️⃣ | Обновить CI/CD и Render-конфигурацию | Чтобы деплой работал с новой авторизацией |
| 4️⃣ | Внедрить 2FA для ADMIN/EDITOR | Усиление безопасности |

### Что ещё может понадобиться?

| Компонент | Назначение | Нужен ли? |
| :--- | :--- | :---: |
| Email-сервис (SMTP, Mailgun) | Уведомления, подтверждение регистрации | ✅ Да |
| OAuth 2.0 + JWT | Безопасная авторизация | ✅ Да |
| 2FA | Защита админов | ✅ Да |
| File storage (S3, MinIO) | Хранение изображений, документов | ✅ Возможно |
| Monitoring (Prometheus + Grafana) | Отслеживание состояния приложения | ✅ В будущем |
| Logging (ELK, Loki) | Централизованные логи | ✅ В будущем |

**Рекомендация для твоего проекта:**
Для сайта администрации или новостного портала:
- **Prometheus + Grafana** — для мониторинга (CPU, RAM, ошибки, алерты).
- **Loki + Grafana** — для логирования (ошибки, запросы, действия пользователей).
- **ELK Stack** — если нужен мощный поиск по логам, но Loki проще и легче.

### Функциональность (Средний приоритет)

- **Загрузка файлов**: Реализовать поддержку загрузки и управления изображениями и другими медиафайлами
  напрямую через API.
- **Расширенный поиск**: Интегрировать полнотекстовый поисковый движок, такой как Elasticsearch или Lucene.
- **Веб-хуки (Webhooks)**: Предоставить систему для отправки уведомлений о событиях во внешние сервисы.

### Архитектура и производительность (Низкий приоритет)

- **Переход на реактивный стек**: Для публичных эндпоинтов с высоким трафиком рассмотреть миграцию с
  блокирующего стека (Spring MVC/JPA) на неблокирующий, реактивный (Spring WebFlux + R2DBC) для
  максимальной масштабируемости и эффективности использования ресурсов.

### Референсные Frontend-реализации

- **Статус**: Находятся в стадии базовой структуры. Требуется полная реализация компонентов и интеграция
  с API.
- **Зависимость**: Полноценная работа над фронтендами будет продолжена после окончательной отладки,
  настройки и проверки бэкенда.
