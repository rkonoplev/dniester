> [Вернуться к содержанию документации](./README.md)

# Технический долг и история улучшений

Этот документ отслеживает историю значимых улучшений, текущие задачи и будущие планы по развитию проекта.

---

## Завершенные задачи и архитектурные решения

Этот раздел служит журналом изменений, документируя ключевые реализованные возможности и рефакторинги,
основанные на анализе текущего состояния кодовой базы.

### Архитектура и Дизайн
- **Слоёная архитектура**: Реализовано четкое разделение на слои Controller, Service и Repository.
- **Принцип единой ответственности**: Логика разделена по доменным областям (новости, роли, авторизация).
- **DTO-паттерн**: Используются Data Transfer Objects для всех API-запросов и ответов, обеспечивая
  изоляцию внутренней модели.
- **Централизованная авторизация**: Логика проверки прав доступа вынесена в `AuthorizationService`.
- **Автоматическое маппинг**: Внедрен MapStruct для автоматического преобразования между DTO и сущностями.

### Безопасность
- **Аутентификация и авторизация**: Интегрирован Spring Security с базовой аутентификацией.
- **Ролевая модель (RBAC)**: Реализована система с ролями (ADMIN, EDITOR) и гранулярными разрешениями.
- **Защита эндпоинтов**: Административные API защищены и требуют соответствующих ролей.

### Производительность
- **Кэширование**: Внедрено кэширование на уровне методов (`@Cacheable`) с использованием Caffeine для
  часто запрашиваемых данных.
- **Ограничение частоты запросов (Rate Limiting)**: Реализована защита API от флуда с помощью Bucket4j.
- **Оптимизация транзакций**: Все методы сервисов, предназначенные только для чтения, аннотированы
  `@Transactional(readOnly = true)`.

### База данных
- **Доступ к данным**: Проект использует блокирующий стек **Spring Data JPA** для простоты и надежности.
- **Управление миграциями**: Схема базы данных управляется с помощью Flyway, обеспечивая версионирование.
- **MySQL как единая СУБД**: Проект использует MySQL для всех сред (разработка, тестирование, продакшн) для обеспечения консистентности.

### Качество кода и CI/CD
- **Статический анализ**: Настроены и интегрированы Checkstyle и PMD для поддержания качества кода.
- **Тестовое покрытие**: Интегрирован JaCoCo для анализа покрытия кода тестами.
- **Рефакторинг тестовой структуры**: Проведено полное разделение тестов на юнит- и интеграционные
  (`unit/` и `integration/`).
- **Настройка Gradle**: `build.gradle` сконфигурирован для раздельного запуска юнит- и интеграционных тестов.
- **Унифицированная архитектура Testcontainers**: Миграция к единому классу `BaseIntegrationTest`,
  использующему Testcontainers MySQL для всех сред (локально и CI).
- **Упрощенный CI пайплайн**: Удалена зависимость Docker Compose из CI, используются Testcontainers везде.
- **Консистентные тестовые среды**: Достигнуто идентичное поведение тестов на всех платформах.
- **Исправление Checkstyle нарушений**: Устранены нарушения правил импорта (AvoidStarImport) в тестовых файлах.
- **Расширение схемы базы данных**: Добавлено поле `site_url` в таблицу `channel_settings` для хранения
  базового URL сайта (миграция V10).
- **Оптимизация CI/CD**: Реализована унифицированная стратегия Testcontainers:
  - Полный переход на MySQL во всех средах
  - Унифицированное интеграционное тестирование с Testcontainers везде
  - Упрощенный CI пайплайн без зависимостей Docker Compose
  - Удалены конфигурации для конкретных сред
  - Достигнуто соответствие продакшену во всех тестовых средах

---

## В процессе

- **Производительность API**: Анализ и оптимизация запросов для сценариев с высоким трафиком. Логирование
  SQL теперь включено в профиле `local` для облегчения диагностики (например, для поиска проблем N+1).

---

## Будущие планы

Этот раздел описывает запланированные функции и улучшения, сгруппированные по приоритетам.

### Безопасность (Высокий приоритет)

- **OAuth 2.0 + JWT**: Переход от Basic Auth к системе аутентификации на основе токенов.
  - **Назначение**: Внедрение современного, безопасного и масштабируемого механизма аутентификации.
  - **Компоненты**: Процессы авторизации OAuth 2.0, генерация и валидация JWT, защита эндпоинтов на основе
    токенов, refresh-токены и обновление процедур входа/выхода.

- **Двухфакторная аутентификация (2FA)**: Добавление второго уровня защиты для административных ролей.
  - **Назначение**: Усиление безопасности для учетных записей с повышенными привилегиями (например, ADMIN, EDITOR).
  - **Компоненты**: Генерация и проверка временных одноразовых паролей (TOTP), интеграция с приложениями-
    аутентификаторами, UI/UX для настройки и подтверждения 2FA.

### Функциональность (Средний приоритет)

- **Загрузка файлов**: Реализация поддержки управления изображениями и другими медиафайлами.
  - **Назначение**: Предоставление пользователям возможности загружать файлы напрямую через API.
  - **Компоненты**: Сервис хранения файлов (например, локальное хранилище, S3 или MinIO), API-эндпоинты
    для загрузки и получения файлов.

- **Функциональность поиска**: Разработка системы поиска для публичной и административной частей.
  - **Назначение**: Предоставить пользователям быстрый и эффективный способ поиска контента.
  - **Этап 1 (Angular и Next.js)**: Реализация базового поиска на стороне сервера. Бэкенд предоставит новый
    API-эндпоинт, использующий SQL `LIKE` или `ILIKE` (для регистронезависимости в PostgreSQL) для поиска
    по заголовкам и содержимому статей.
  - **Этап 2 (Next.js - Перспектива)**: Для фронтенда на Next.js рассмотреть внедрение поиска на стороне
    клиента с помощью **Pagefind**. Этот инструмент создает статический поисковый индекс во время сборки,
    обеспечивая мгновенный поиск без нагрузки на API. Это улучшение будет оцениваться после завершения Этапа 1.

- **Веб-хуки (Webhooks)**: Разработка системы для уведомлений на основе событий.
  - **Назначение**: Уведомление внешних сервисов о конкретных событиях в приложении.
  - **Компоненты**: Механизм для управления подписками на веб-хуки и отправки данных о событиях.

- **Интеграция с Telegram**: Автоматическая публикация анонсов статей в Telegram-канал.
  - **Назначение**: Расширение дистрибуции контента и оперативное информирование подписчиков.
  - **Компоненты**: Telegram Bot клиент, сервис для прослушивания событий создания/публикации статей,
    форматирование сообщений (превью, ссылка), безопасное хранение токена бота.

### Архитектура и производительность (Низкий приоритет)

- **Переход на реактивный стек**: Рассмотреть миграцию публичных эндпоинтов с высоким трафиком на
  неблокирующий стек.
  - **Назначение**: Максимизация масштабируемости и эффективности использования ресурсов при высоких нагрузках.
  - **Компоненты**: Spring WebFlux и R2DBC для конкретных, критически важных к производительности частей
    приложения.

### Последовательность внедрения

1.  **Завершение бизнес-логики и API**: Завершить и стабилизировать основные функции приложения.
2.  **Внедрение OAuth 2.0 + JWT**: Создание основного механизма аутентификации и авторизации.
3.  **Обновление CI/CD и конфигурации развертывания**: Обеспечение совместимости процесса развертывания с
    новой системой аутентификации.
4.  **Внедрение 2FA**: Добавление двухфакторной аутентификации для административных ролей в качестве
    дополнительного уровня безопасности.

### Поддерживающая инфраструктура и сервисы

- **Email-сервис (например, SMTP, Mailgun)**
  - **Назначение**: Необходим для уведомлений пользователей, подтверждения регистрации и восстановления
    пароля/2FA.
- **Файловое хранилище (например, S3, MinIO)**
  - **Назначение**: Для хранения загружаемого пользователями контента, такого как изображения и документы.
    Решение будет принято на основе финальных требованиях к функциональности.
- **Мониторинг и логирование (Grafana Cloud)**
  - **Назначение**: Централизованный мониторинг приложений (Prometheus) и агрегация логов (Loki).
    Рекомендуется для продуктивной среде. Совместимо с бесплатными тарифами облачных хостинг-платформ,
    поскольку не требует локального постоянного диска.

### Референсные Frontend-реализации

- **Статус**: Находятся в стадии базовой структуры. Требуется полная реализация компонентов и интеграция
  с API.
- **Зависимость**: Полноценная работа над фронтендами будет продолжена после окончательной отладки,
  настройки и проверки бэкенда.
