> [Вернуться к содержанию документации](./README.md) | [Краткое руководство по началу работы](./QUICK_START_RU.md) | [Руководство разработчика](./DEVELOPER_GUIDE_RU.md)

# Тестирование и разработка с Makefile

## Содержание

- [Быстрая справка](#быстрая-справка)
- [Рабочие процессы разработки](#рабочие-процессы-разработки)
  - [1. Разработка полного стека](#1-разработка-полного-стека)
  - [2. Разработка только бэкенда](#2-разработка-только-бэкенда)
  - [3. Рабочие процессы тестирования](#3-рабочие-процессы-тестирования)
    - [Быстрые интеграционные тесты](#быстрые-интеграционные-тесты)
    - [Полный набор тестов](#полный-набор-тестов)
    - [Проверки качества кода](#проверки-качества-кода)
- [Требования к окружению](#требования-к-окружению)
  - [Для `make run` и `make stop`](#для-make-run-и-make-stop)
  - [Для `make test` и `make all-tests`](#для-make-test-и-make-all-tests)
  - [Для `make boot`](#для-make-boot)
- [Детали конфигурации](#детали-конфигурации)
  - [Docker Compose (`make run`)](#docker-compose-make-run)
  - [Testcontainers (`make test`)](#testcontainers-make-test)
  - [Локальная разработка (`make boot`)](#локальная-разработка-make-boot)
- [Устранение неполадок](#устранение-неполадок)
  - [Проблемы со сборкой и кэшем](#проблемы-со-сборкой-и-кэшем)
  - [Проблемы с Docker](#проблемы-с-docker)
  - [Проблемы с тестами](#проблемы-с-тестами)
  - [Проблемы с локальным MySQL](#проблемы-с-локальным-mysql)
- [Лучшие практики](#лучшие-практики)
- [Интеграция с IDE](#интеграция-с-ide)
  - [IntelliJ IDEA](#intellij-idea)
  - [VS Code](#vs-code)
- [Интеграция CI/CD](#интеграция-cicd)

Это руководство объясняет, как использовать команды Makefile для разработки и тестирования.

## Быстрая справка

| Команда | Описание | Случай использования |
|:---|:---|:---|
| `make run` | Запустить весь проект (Docker Compose) | Ручное тестирование, разработка фронтенда |
| `make stop` | Остановить проект | Чистое завершение |
| `make rebuild` | Пересобрать бэкенд без кэша и запустить | Исправление проблем с кэшем сборки |
| `make hard-rebuild` | Остановить, пересобрать бэкенд без кэша, запустить | Когда `rebuild` не помогает |
| `make reset` | **Удалить все контейнеры и данные БД** | Полный сброс окружения |
| `make test` | Запустить интеграционные тесты (Testcontainers) | Быстрая обратная связь |
| `make all-tests` | Запустить все тесты (юнит + интеграционные) | Полная проверка |
| `make boot` | Запустить бэкенд локально | Разработка с локальным MySQL |
| `make clean` | Очистить артефакты сборки | Свежий старт |
| `make lint` | Запустить статический анализ | Проверка качества кода |
| `make coverage` | Сгенерировать отчет покрытия | Отчеты покрытия |

## Рабочие процессы разработки

### 1. Разработка полного стека
Для разработки фронтенда и бэкенда с живой перезагрузкой:

```bash
# Запустить всё (MySQL + бэкенд + фронтенд)
make run
```

**Доступ к сервисам:**
- API: [http://localhost:8080](http://localhost:8080)
- Swagger: [http://localhost:8080/swagger-ui/index.html](http://localhost:8080/swagger-ui/index.html)
- Фронтенд: [http://localhost:3000](http://localhost:3000) (если доступен)

> **Подсказка**: Учетные данные для входа (логины и пароли) для разных ролей описаны в файле **[DATABASE_GUIDE_RU.md](./DATABASE_GUIDE_RU.md)**.

```bash
# Остановить по завершении
make stop
```

### 2. Разработка только бэкенда
Для разработки API без фронтенда:

```bash
# Вариант A: С Docker Compose (рекомендуется)
make run

# Вариант B: Локальная разработка (требует локальный MySQL)
make boot
```

### 3. Рабочие процессы тестирования

#### Быстрые интеграционные тесты
```bash
# Запустить интеграционные тесты с Testcontainers
make test
```
- Использует Testcontainers (Docker Compose не нужен)
- Запускает свежий контейнер MySQL для каждого запуска тестов
- Быстрая обратная связь

#### Полный набор тестов
```bash
# Запустить все тесты (юнит + интеграционные)
make all-tests
```
- Комплексная проверка
- Включает покрытие кода
- Использовать перед коммитами/PR

#### Проверки качества кода
```bash
# Запустить статический анализ
make lint

# Сгенерировать отчет покрытия
make coverage
```

## Требования к окружению

### Для `make run` и `make stop`
- Docker и Docker Compose
- Локальный MySQL не нужен

### Для `make test` и `make all-tests`
- Docker (для Testcontainers)
- Docker Compose не нужен
- Локальный MySQL не нужен

### Для `make boot`
- Локальный MySQL 8.0+ запущен
- База данных: `phoebe_db`
- Пользователь: `root` / Пароль: `root`
- Или настроить через переменные окружения

## Детали конфигурации

### Docker Compose (`make run`)
- **MySQL**: Постоянные данные в Docker volume
- **Бэкенд**: Горячая перезагрузка с Spring Boot DevTools
- **Фронтенд**: Живая перезагрузка (если настроена)

### Testcontainers (`make test`)
- **MySQL**: Свежий контейнер для каждого запуска тестов
- **Изоляция**: Каждый тест получает чистую базу данных
- **Производительность**: Оптимизировано для CI/CD

### Локальная разработка (`make boot`)
- **MySQL**: Ваша локальная установка
- **Гибкость**: Прямой доступ к базе данных
- **Скорость**: Без накладных расходов контейнера

## Устранение неполадок

### Проблемы со сборкой и кэшем
Если приложение ведет себя неожиданно после изменений в коде (особенно в `build.gradle`), попробуйте следующие команды по порядку:

1.  **`make rebuild`**: Пересобирает бэкенд без кэша. Это решает большинство проблем, связанных с зависимостями.
2.  **`make hard-rebuild`**: Если `rebuild` не помог, эта команда выполняет более глубокую очистку перед пересборкой.
3.  **`make reset`**: **ОСТОРОЖНО!** Используйте в крайнем случае. Удаляет контейнеры и **все данные в базе данных**. Возвращает окружение к исходному состоянию.

### Проблемы с Docker
```bash
# Если контейнеры зависли
make stop
docker system prune -f

# Перезапуск
make run
```

### Проблемы с тестами
```bash
# Очистить и повторить
make clean
make test
```

### Проблемы с локальным MySQL
```bash
# Проверить статус MySQL
brew services list | grep mysql

# Запустить MySQL (macOS с Homebrew)
brew services start mysql

# Создать базу данных
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS phoebe_db;"
```

## Лучшие практики

1. **Используйте `make test` для быстрой обратной связи** во время разработки
2. **Используйте `make all-tests` перед коммитами** для полной проверки
3. **Используйте `make run` для ручного тестирования** с фронтендом
4. **Используйте `make boot` только если у вас есть локальный MySQL** и нужен прямой доступ
5. **Всегда выполняйте `make stop`** для очистки ресурсов Docker

## Интеграция с IDE

### IntelliJ IDEA
- Конфигурации запуска могут использовать команды `make`
- Интеграция терминала: `Tools > Terminal`
- Внешние инструменты: `Tools > External Tools`

### VS Code
- Задачи можно настроить для запуска команд `make`
- Встроенный терминал поддерживает `make`
- Доступны расширения для синтаксиса Makefile

## Интеграция CI/CD

Рабочий процесс GitHub Actions использует Testcontainers напрямую:
```yaml
- name: Run tests
  run: cd backend && ./gradlew clean build integrationTest jacocoTestReport --no-daemon
```

Это эквивалентно локальному запуску `make all-tests`.