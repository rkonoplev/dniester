# Руководство по Docker

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Содержание
- [Локальная разработка с Docker Compose](#локальная-разработка-с-docker-compose)
  - [Понимание `docker-compose.yml` и `docker-compose.override.yml`](#понимание-docker-composeyml-и-docker-composeoverrideyml)
- [Сборка для продакшена с Docker](#сборка-для-продакшена-с-docker)
- [Лучшие практики](#лучшие-практики)


Этот документ объясняет, как работать с Docker в Phoebe CMS, как для локальной разработки,
так и для развертывания в продакшене.

---

## Локальная разработка с Docker Compose

Проект использует подход с двумя файлами для Docker Compose, чтобы отделить основную архитектуру приложения
от удобств локальной разработки.

### Понимание `docker-compose.yml` и `docker-compose.override.yml`

#### `docker-compose.yml` (Архитектурный план)
-   **Назначение**: Определяет фундаментальные сервисы, из которых состоит приложение. Он гласит, что платформа
    состоит из сервиса `backend` и сервиса `database`.
-   **Аналогия**: Думайте об этом файле как об архитектурном плане здания. Он описывает фундамент, количество
    этажей и основную структуру. Он важен и универсален для любой среды.

#### `docker-compose.override.yml` (Инструменты разработчика)
-   **Назначение**: Предоставляет локальные, специфичные для разработки переопределения. Этот файл автоматически
    и прозрачно используется Docker Compose при запуске `docker-compose up`.
-   **Аналогия**: Это временные строительные леса для постройки здания. Они необходимы для процесса разработки,
    но не являются частью финальной структуры.
-   **Содержимое**: Обычно включает конфигурации, полезные только для локальной разработки, такие как:
    -   **Проброс портов**: Открытие порта БД на хост-машину для прямого доступа с помощью GUI-клиента (например, `3306:3306` для MySQL).
    -   **Монтирование томов**: Монтирование локального исходного кода в контейнер. Это позволяет контейнеру видеть изменения в файлах, но для "горячей" перезагрузки приложения требуются дополнительные инструменты (например, `spring-boot-devtools`).

Такое разделение гарантирует, что базовый `docker-compose.yml` остается чистым и представляет архитектуру
продакшена, в то время как у разработчиков есть гибкость для настройки своей локальной среды.

Для запуска бэкенда и базы данных вместе для локальной разработки выполните:

```bash
docker-compose up --build
```
*   **Примечание**: Рекомендуемый способ запуска локальной среды разработки — использовать команду `make run`, которая автоматизирует этот процесс.

---

## Сборка для продакшена с Docker

1.  **Соберите JAR-файл приложения**:
    ```bash
    cd backend
    ./gradlew bootJar
    ```

2.  **Соберите Docker-образ для продакшена**:
    ```bash
    docker build -t phoebe-cms:1.0.0 -f Dockerfile .
    ```
    *   **Примечание**: Рекомендуется использовать конкретные версии (например, `phoebe-cms:1.0.0`) вместо тега `:latest` для стабильности и воспроизводимости в продакшене.

3.  **Запустите контейнер для продакшена**:
    ```bash
    docker run -d -p 8080:8080 --env-file .env.prod phoebe-cms:1.0.0
    ```
    *   **Примечание**: Для продакшен-развертываний рекомендуется использовать менеджеры секретов (например, Kubernetes Secrets, HashiCorp Vault, AWS Secrets Manager) вместо `--env-file` для более безопасного управления конфиденциальными данными. Использование `--env-file` подходит для простых развертываний или тестирования.

   - Основан на легковесном образе JRE.
   - Содержит только скомпилированный JAR (без исходного кода).
   - Конфигурация поступает из переменных окружения.

---

## Лучшие практики
- Держите Dockerfile для продакшена минимальным (без Gradle, только JAR).
- Используйте `Dockerfile.dev` для продуктивности разработчика (смонтированный исходный код, `bootRun`).
- **Храните дампы базы данных в директории `./db_dumps`** для удобства импорта/экспорта.
- Управляйте всеми секретами через `.env` (локально) и менеджер секретов (CI/CD/Prod).
- Убедитесь, что секреты и файлы `.env` исключены из git.
