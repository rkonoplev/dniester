> [Вернуться к содержанию документации](./README.md)

# Руководство по Docker

> Для определения ключевых терминов и технологий, пожалуйста, обратитесь к **[Глоссарию](./GLOSSARY_RU.md)**.

## Содержание
- [Локальная разработка с Docker Compose](#локальная-разработка-с-docker-compose)
- [Практические сценарии и команды](#практические-сценарии-и-команды)
- [Сборка для продакшена с Docker](#сборка-для-продакшена-с-docker)
- [Лучшие практики](#лучшие-практики)

Этот документ объясняет, как работать с Docker в Phoebe CMS, как для локальной разработки,
так и для развертывания в продакшене.

---

## Локальная разработка с Docker Compose

Проект использует подход с двумя файлами для Docker Compose, чтобы отделить основную архитектуру приложения
от удобств локальной разработки.

### Понимание `docker-compose.yml` и `docker-compose.override.yml`

#### `docker-compose.yml` (Архитектурный план)
-   **Назначение**: Определяет фундаментальные сервисы, из которых состоит приложение. Он гласит, что платформа
    состоит из сервиса `backend`, `database` и `frontend`.
-   **Аналогия**: Думайте об этом файле как об архитектурном плане здания. Он описывает фундамент, количество
    этажей и основную структуру. Он важен и универсален для любой среды.

#### `docker-compose.override.yml` (Инструменты разработчика)
-   **Назначение**: Предоставляет локальные, специфичные для разработки переопределения. Этот файл автоматически
    и прозрачно используется Docker Compose при запуске `docker-compose up`.
-   **Аналогия**: Это временные строительные леса для постройки здания. Они необходимы для процесса разработки,
    но не являются частью финальной структуры.
-   **Содержимое**: Обычно включает конфигурации, полезные только для локальной разработки, такие как:
    -   **Проброс портов**: Открытие порта БД на хост-машину для прямого доступа (`3306:3306`).
    -   **Монтирование томов**: Монтирование локального исходного кода в контейнер для "горячей" перезагрузки.

Такое разделение гарантирует, что базовый `docker-compose.yml` остается чистым, в то время как у разработчиков есть
гибкость для настройки своей локальной среды.

Для запуска бэкенда и базы данных вместе для локальной разработки выполните:
```bash
docker-compose up --build
```
*   **Примечание**: Рекомендуемый способ запуска локальной среды разработки — использовать команду `make run`, которая автоматизирует этот процесс.

---

## Практические сценарии и команды

Хотя `make`— это основной интерфейс, понимание команд `docker compose` под капотом дает больше гибкости.

### Рекомендации для частых задач

| Цель | Команды |
|:---|:---|
| Быстро перезапустить с обновленным кодом | `docker compose up --build phoebe-app` |
| Полностью очистить и пересоздать | `docker compose down -v`<br>`docker compose build --no-cache phoebe-app`<br>`docker compose up` |
| Проверить только один сервис | `docker compose up phoebe-app` |
| Полная пересборка всех сервисов | `docker compose build --no-cache`<br>`docker compose up` |

### Сравнение команд `docker compose` и `make`

| Команда `docker compose` | Что делает | Эквивалент `make` | Примечания |
|:---|:---|:---|:---|
| `docker compose up` | Запускает контейнеры. Если образа нет — соберёт (с кэшем). | `make run` (старая версия) | Быстрая команда для обычной разработки. |
| `docker compose up --build` | Перед запуском всегда пересобирает образы, но использует кэш. | `make run` | Обеспечивает обновление после изменений в коде. |
| `docker compose up --build phoebe-app` | Пересобирает только `phoebe-app` (с кэшем) и запускает сервисы. | - | Быстрее, если нужно обновить только бэкенд. |
| `docker compose build --no-cache phoebe-app` | Полностью пересобирает образ `phoebe-app` без кэша. | `make rebuild` | Полезно при изменениях в `Dockerfile` или `build.gradle`. |
| `docker compose down` | Останавливает и удаляет контейнеры, но оставляет volume. | `make stop` | **Безопасно**: данные MySQL сохраняются. |
| `docker compose down -v` | Останавливает всё и удаляет volume. | `make reset` | **Опасно**: сбрасывает базу данных. Используйте для старта "с чистого листа". |

### В чем разница: `--build` против `--no-cache`?

- **`--build`** = обновление с кэшем (быстро).
  - Docker пересобирает только те слои образа, которые изменились. Идеально для ежедневной разработки.
  - Команда: `docker compose up --build`

- **`--no-cache`** = пересборка с нуля (чисто, но медленно).
  - Docker игнорирует весь кэш и собирает образ с самого начала.
  - Используйте это, когда меняете `Dockerfile`, зависимости в `build.gradle` или когда кэш вызывает проблемы.
  - Команда: `docker compose build --no-cache phoebe-app`

---

## Сборка для продакшена с Docker

1.  **Соберите JAR-файл приложения**:
    ```bash
    cd backend
    ./gradlew bootJar
    ```

2.  **Соберите Docker-образ для продакшена**:
    ```bash
    docker build -t phoebe-cms:1.0.0 -f Dockerfile .
    ```
    *   **Примечание**: Рекомендуется использовать конкретные версии (например, `phoebe-cms:1.0.0`) вместо тега `:latest`.

3.  **Запустите контейнер для продакшена**:
    ```bash
    docker run -d -p 8080:8080 --env-file .env.prod phoebe-cms:1.0.0
    ```
    *   **Примечание**: Для продакшена рекомендуется использовать менеджеры секретов (например, Kubernetes Secrets, Vault) вместо `--env-file`.

   - Основан на легковесном образе JRE.
   - Содержит только скомпилированный JAR (без исходного кода).
   - Конфигурация поступает из переменных окружения.

---

## Лучшие практики
- Держите Dockerfile для продакшена минимальным (без Gradle, только JAR).
- Используйте `Dockerfile.dev` для продуктивности разработчика (смонтированный исходный код, `bootRun`).
- **Храните дампы базы данных в директории `./db_dumps`** для удобства импорта/экспорта.
- Управляйте всеми секретами через `.env` (локально) и менеджер секретов (CI/CD/Prod).
- Убедитесь, что секреты и файлы `.env` исключены из git.
