> [Вернуться к содержанию документации](./README.md) | [Руководство по базе данных](./DATABASE_GUIDE_RU.md)

# Руководство по командам MySQL

Этот документ содержит полезные команды для работы с MySQL, как в Docker-контейнере, так и при локальной установке.

## Содержание
- [Работа с MySQL в Docker-контейнере](#работа-с-mysql-в-docker-контейнере)
- [Работа с локальной установкой MySQL](#работа-с-локальной-установкой-mysql)
- [Манипуляции с данными в БД](#манипуляции-с-данными-в-бд)
  - [1. Изменение данных в конкретных ячейках](#1-изменение-данных-в-конкретных-ячейках)
  - [2. Массовое исправление путей к изображениям и удаление HTML-тегов](#2-массовое-исправление-путей-к-изображениям-и-удаление-html-тегов)
    - [Сценарий 1: Перемещение изображений в локальные папки проекта](#сценарий-1-перемещение-изображений-в-локальные-папки-проекта)
    - [Сценарий 2: Перемещение изображений на сторонние сервера](#сценарий-2-перемещение-изображений-на-сторонние-сервера)
  - [3. Управление учетными записями CMS (Администратор/Редактор)](#3-управление-учетными-записями-cms-администраторредактор)
    - [Изменение пароля существующего пользователя](#изменение-пароля-существующего-пользователя)
    - [Создание нового пользователя (Администратор/Редактор)](#создание-нового-пользователя-администраторредактор)

---

## Работа с MySQL в Docker-контейнере

Предполагается, что ваш MySQL-контейнер запущен и имеет имя `phoebe-mysql`.

### Подключение в интерактивный режим:

```bash
docker exec -it phoebe-mysql mysql -uroot -proot
```

### Внутри MySQL (после подключения, появляется `mysql>`):

**Посмотреть все базы данных:**
```sql
SHOW DATABASES;
```

**Переключиться в базу данных:**
```sql
USE phoebe_db;
```

**Посмотреть таблицы в текущей базе:**
```sql
SHOW TABLES;
```

**Пример: посчитать записи в таблице `content`:**
```sql
SELECT COUNT(*) FROM content;
```

**Выйти из MySQL-клиента:**
```sql
EXIT;
```

### Экспорт данных (создание дампа БД):

**Дамп всей базы `phoebe_db`:**
```bash
docker exec -i phoebe-mysql mysqldump -uroot -proot phoebe_db > db_data/exported_dump.sql
```

**Дамп конкретной таблицы (например, `users`):**
```bash
docker exec -i phoebe-mysql mysqldump -uroot -proot phoebe_db users > db_data/users_dump.sql
```

### Импорт данных (загрузка дампа в БД):

```bash
docker exec -i phoebe-mysql mysql -uroot -proot phoebe_db < db_data/exported_dump.sql
```

### Примечания:

-   В командах экспорта/импорта указывайте имя базы данных (например, `phoebe_db`).
-   Перед импортом база данных должна существовать.
-   Дамп — это обычный `.sql` файл, его можно хранить в папке `db_data` для удобства.

---

## Работа с локальной установкой MySQL

Если MySQL установлен непосредственно на вашей машине, команды будут похожи, но без префикса `docker exec`.
Предполагается, что MySQL-сервер запущен, и вы знаете имя пользователя (`-u`) и пароль (`-p`).

### Подключение в интерактивный режим:

```bash
mysql -u <username> -p
# Например: mysql -u root -p
```
После ввода команды система запросит пароль.

### Внутри MySQL (после подключения, появляется `mysql>`):

Команды внутри MySQL-клиента идентичны тем, что используются в Docker-контейнере:

**Посмотреть все базы данных:**
```sql
SHOW DATABASES;
```

**Переключиться в базу данных:**
```sql
USE phoebe_db;
```

**Посмотреть таблицы в текущей базе:**
```sql
SHOW TABLES;
```

**Пример: посчитать записи в таблице `content`:**
```sql
SELECT COUNT(*) FROM content;
```

**Выйти из MySQL-клиента:**
```sql
EXIT;
```

### Экспорт данных (создание дампа БД):

**Дамп всей базы `phoebe_db`:**
```bash
mysqldump -u <username> -p phoebe_db > db_data/exported_dump.sql
# Например: mysqldump -u root -p phoebe_db > db_data/exported_dump.sql
```

**Дамп конкретной таблицы (например, `users`):**
```bash
mysqldump -u <username> -p phoebe_db users > db_data/users_dump.sql
# Например: mysqldump -u root -p phoebe_db users > db_data/users_dump.sql
```

### Импорт данных (загрузка дампа в БД):

```bash
mysql -u <username> -p phoebe_db < db_data/exported_dump.sql
# Например: mysql -u root -p phoebe_db < db_data/exported_dump.sql
```

---

## Манипуляции с данными в БД

Этот раздел описывает команды SQL для изменения данных в базе данных, включая точечные исправления, массовые обновления и управление учетными записями пользователей.

### 1. Изменение данных в конкретных ячейках

Для изменения значения в одной или нескольких конкретных ячейках используйте команду `UPDATE` с условием `WHERE`.

**Пример: Изменить заголовок статьи с `id = 1`:**
```sql
UPDATE content
SET title = 'Новый заголовок статьи'
WHERE id = 1;
```

**Пример: Изменить статус публикации статьи с `id = 5`:**
```sql
UPDATE content
SET published = TRUE
WHERE id = 5;
```

**Пример: Изменить email пользователя `admin`:**
```sql
UPDATE users
SET email = 'new_admin@example.com'
WHERE username = 'admin';
```

### 2. Массовое исправление путей к изображениям и удаление HTML-тегов

Часто после миграции или реорганизации файловой структуры требуется обновить пути к изображениям или очистить контент от устаревших HTML-тегов.

#### Сценарий 1: Перемещение изображений в локальные папки проекта

Если изображения теперь хранятся в папках внутри вашего проекта (например, `/images/uploads/`), и вам нужно обновить пути в тегах `<img>` в полях `body` или `teaser`.

**Пример: Изменение пути `src` в тегах `<img>`:**
Предположим, старый путь был `http://old-domain.com/sites/default/files/` и его нужно заменить на `/images/uploads/`.

```sql
UPDATE content
SET
    body = REPLACE(body, 'http://old-domain.com/sites/default/files/', '/images/uploads/'),
    teaser = REPLACE(teaser, 'http://old-domain.com/sites/default/files/', '/images/uploads/')
WHERE
    body LIKE '%http://old-domain.com/sites/default/files/%' OR
    teaser LIKE '%http://old-domain.com/sites/default/files/%';
```
*   **Важно**: Команда `REPLACE` чувствительна к регистру. Убедитесь, что вы заменяете точную строку.

**Пример: Удаление конкретных HTML-тегов (например, `<img>`):**
Если вы хотите полностью удалить все теги `<img>` из контента, это сложнее сделать чистым SQL, так как MySQL не имеет встроенной поддержки регулярных выражений для замены (только для поиска через `REGEXP`). Для таких задач обычно используют скрипты на уровне приложения (PHP, Python, Java) или более мощные СУБД с поддержкой `REGEXP_REPLACE`.

Однако, если теги имеют предсказуемую структуру, можно использовать комбинацию `REPLACE` для удаления известных частей. Это не идеально, но может помочь в простых случаях.

```sql
-- Пример: Удаление конкретного тега <img> с известным src
UPDATE content
SET
    body = REPLACE(body, '<img src="/old/path/image.jpg">', ''),
    teaser = REPLACE(teaser, '<img src="/old/path/image.jpg">', '')
WHERE
    body LIKE '%<img src="/old/path/image.jpg">%' OR
    teaser LIKE '%<img src="/old/path/image.jpg">%';
```
*   **Для сложных случаев с HTML-тегами рекомендуется использовать инструменты на уровне приложения**, которые могут парсить HTML и безопасно модифицировать его.

#### Сценарий 2: Перемещение изображений на сторонние сервера

Если изображения перемещаются на сторонний CDN или файловое хранилище (например, S3, Cloudinary), вам нужно обновить пути на новые URL.

**Пример: Изменение пути `src` на новый домен CDN:**
Предположим, старый путь был `/images/uploads/` и его нужно заменить на `https://cdn.new-domain.com/assets/`.

```sql
UPDATE content
SET
    body = REPLACE(body, '/images/uploads/', 'https://cdn.new-domain.com/assets/'),
    teaser = REPLACE(teaser, '/images/uploads/', 'https://cdn.new-domain.com/assets/')
WHERE
    body LIKE '%/images/uploads/%' OR
    teaser LIKE '%/images/uploads/%';
```

### 3. Управление учетными записями CMS (Администратор/Редактор)

В случае утери пароля или необходимости создания новой учетной записи администратора/редактора извне (например, через прямой доступ к БД), можно использовать следующие команды.

**Важно**: Пароли в Phoebe CMS хранятся в виде BCrypt хешей. Для установки нового пароля вам потребуется сгенерировать его хеш.

#### Изменение пароля существующего пользователя

1.  **Сгенерируйте BCrypt хеш для нового пароля.**
    Вы можете использовать онлайн-генератор BCrypt хешей или функцию в вашем приложении. Например, для пароля `new_secret_password` хеш может выглядеть так:
    `$2a$12$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9P8jF4l3q4R4J8C` (это пример, ваш хеш будет другим).

2.  **Обновите пароль в таблице `users`:**
    ```sql
    UPDATE users
    SET password = '$2a$12$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9P8jF4l3q4R4J8C' -- Замените на ваш сгенерированный хеш
    WHERE username = 'admin'; -- Или 'editor', или другой username
    ```

#### Создание нового пользователя (Администратор/Редактор)

Для создания нового пользователя вам потребуется добавить запись в таблицу `users` и связать ее с соответствующей ролью в `user_roles`.

1.  **Сгенерируйте BCrypt хеш для нового пароля** (см. выше).

2.  **Добавьте нового пользователя в таблицу `users`:**
    ```sql
    INSERT INTO users (username, password, email, active)
    VALUES ('new_admin_user', '$2a$12$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9P8jF4l3q4R4J8C', 'new_admin@example.com', TRUE);
    ```

3.  **Получите `id` только что созданного пользователя:**
    ```sql
    SELECT id FROM users WHERE username = 'new_admin_user';
    -- Предположим, id = 10
    ```

4.  **Получите `id` нужной роли (например, `ADMIN` или `EDITOR`):**
    ```sql
    SELECT id FROM roles WHERE name = 'ADMIN';
    -- Предположим, id = 1
    ```

5.  **Свяжите пользователя с ролью в таблице `user_roles`:**
    ```sql
    INSERT INTO user_roles (user_id, role_id)
    VALUES (10, 1); -- Замените 10 на id пользователя, 1 на id роли
    ```
    Теперь `new_admin_user` будет иметь роль `ADMIN`.

---