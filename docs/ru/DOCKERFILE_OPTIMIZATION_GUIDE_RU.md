> [Назад к содержанию документации](./README.md)

# Руководство по оптимизации Dockerfile для Frontend

В этом документе рассматриваются два основных подхода к созданию `Dockerfile` для frontend-приложения (`phoebe-nextjs`):
простой одностадийный для разработки и отладки и более сложный многостадийный для оптимизации и продакшена.

## 1. Упрощенный одностадийный Dockerfile

Этот вариант идеально подходит для быстрой отладки, первоначальной настройки или для решения проблем со сборкой
в изолированной среде.

```dockerfile
# Пример простого Dockerfile
FROM node:20-alpine
WORKDIR /app

# Копируем package файлы
COPY package.json package-lock.json ./
RUN npm install

# Копируем исходный код
COPY . .

# Собираем приложение
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"]
```

### Сценарии применения

*   **Быстрая отладка проблем со сборкой**: Если `make run` дает сбои на этапе сборки фронтенда, этот `Dockerfile` поможет
    изолировать проблему. Он убирает сложности многостадийности и позволяет проверить, собирается ли приложение
    в чистой среде.

*   **Первоначальная настройка нового frontend-сервиса**: Если вы решите добавить еще один frontend-микросервис,
    этот `Dockerfile` послужит отличной и надежной отправной точкой.

**Вывод**: Этот вариант — ваш "аварийный" или "стартовый" набор. Он не для ежедневного использования, а для решения
конкретных проблем со сборкой или для быстрого старта.

---

## 2. Оптимизированный многостадийный Dockerfile

Это стратегически важное улучшение для вашего проекта, которое понадобится при переходе к CI/CD и развертыванию на
продакшен-серверах.

```dockerfile
# 1. Установка зависимостей
FROM node:20-alpine AS deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --only=production

# 2. Сборка приложения
FROM node:20-alpine AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# 3. Финальный образ для продакшена
FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV production

RUN addgroup -g 1001 -S nodejs && adduser -S nextjs -u 1001

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

USER nextjs
EXPOSE 3000
ENV PORT 3000
CMD ["npm", "start"]
```

### Преимущества для CI/CD и продакшена

1.  **Оптимизация CI/CD пайплайна**:
    *   **Скорость сборки**: Docker кэширует стадию `deps`. Пересборка зависимостей происходит только при изменении
        `package.json`, что значительно ускоряет CI/CD.
    *   **Надежность**: `npm ci` гарантирует установку тех же версий зависимостей, что и локально, предотвращая ошибки
        "у меня работает, а на сервере нет".

2.  **Подготовка к продакшену (Deployment)**:
    *   **Маленький размер образа**: Финальный образ (`runner`) содержит только скомпилированное приложение
        и production-зависимости, что ускоряет его загрузку на серверы.
    *   **Безопасность**: Запуск приложения от имени пользователя без root-прав (`USER nextjs`) — это стандартная практика
        безопасности для минимизации рисков.

**Вывод**: Этот Dockerfile — следующий шаг в развитии проекта. Его стоит внедрить при настройке CI/CD. Можно использовать
`Dockerfile.dev` для локальной разработки и `Dockerfile.prod` для продакшена.