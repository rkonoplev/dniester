# Руководство по стратегии тестирования

Этот документ объясняет унифицированную стратегию тестирования, используемую в Phoebe CMS с Testcontainers везде.

---

## Обзор архитектуры тестирования

### Типы тестов и среды

| Тип теста | Среда | База данных | Базовый класс | Профиль |
|-----------|-------|-------------|---------------|---------|
| **Unit тесты** | Любая | Только моки | N/A | `test` |
| **Интеграционные тесты** | Все (локальная и CI) | Testcontainers MySQL | `BaseIntegrationTest` | `integration-test` |

---

## Унифицированная стратегия интеграционного тестирования

### Все среды (локальная и CI)
```java
// Унифицированный подход - работает идентично везде
@ActiveProfiles("integration-test")
@Testcontainers
class NewsServiceTest extends BaseIntegrationTest {
    // MySQL контейнер автоматически запускается/останавливается
    // Идентичное поведение в локальной разработке и CI
    // Не требуется ручная настройка Docker нигде
}
```

---

## Конфигурация среды

### Конфигурация задач Gradle
```bash
# Работает идентично во всех средах
./gradlew integrationTest
# Использует BaseIntegrationTest с Testcontainers везде
```

### Логика выбора профиля
- **Единый профиль**: `integration-test` для всех интеграционных тестов
- **Автоматически**: Все тесты наследуют `BaseIntegrationTest`
- **Консистентно**: Идентичное поведение на всех платформах

---

## Преимущества унифицированного подхода

### Универсальные преимущества
- **Нулевая настройка**: Docker Compose не требуется нигде
- **Консистентность**: Идентичные тестовые среды везде
- **Изоляция**: Каждый запуск теста получает свежую базу данных
- **Простота**: Единый подход для всех сред
- **Надежность**: Нет проблем конфигурации для конкретной среды

### Преимущества локальной разработки
- **Без ручной настройки**: Testcontainers управляет всем
- **Легкая отладка**: Логи контейнера доступны
- **Быстрая итерация**: Быстрые циклы тестирования

### Преимущества CI среды  
- **Упрощенный пайплайн**: Нет настройки Docker Compose
- **Эффективность ресурсов**: Автоматическое управление контейнерами
- **Надежность**: Нет внешних зависимостей
- **Более быстрое выполнение**: Нет ручной координации сервисов

---

## Руководство по миграции

### С гибридного подхода
```java
// СТАРЫЙ: Множественные базовые классы для разных сред
class MyTest extends LocalIntegrationTest {     // Только локально
class MyTest extends AbstractIntegrationTest { // Только CI
```

### К унифицированному подходу
```java
// НОВЫЙ: Единый базовый класс для всех сред
class MyTest extends BaseIntegrationTest {
    // Работает идентично везде
}
```

---

## Лучшие практики

1. **Используйте BaseIntegrationTest** для всех интеграционных тестов
2. **Держите unit тесты быстрыми** только с моками
3. **Тестируйте миграции базы данных** в интеграционных тестах
4. **Проверяйте соответствие продакшену** с реальным MySQL во всех тестах
5. **Позвольте Testcontainers управлять жизненным циклом** - никакого ручного управления контейнерами

---

## Устранение неполадок

### Частые проблемы
- **Testcontainers не запускается**: Проверьте, что Docker daemon запущен
- **Тесты зависают**: Убейте зависшие процессы и контейнеры (см. руководство Git Bash Commands)
- **Проблемы с памятью**: Убедитесь в достаточном выделении памяти Docker

### Команды для отладки
```bash
# Запустить конкретный тест
./gradlew integrationTest --tests "NewsServiceTest"

# Проверить Docker контейнеры
docker ps

# Очистить зависшие контейнеры
docker stop $(docker ps -q --filter "label=org.testcontainers")

# Проверить логи тестов
./gradlew integrationTest --info
```