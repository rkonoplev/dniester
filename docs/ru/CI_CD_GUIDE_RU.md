# Руководство по CI/CD и безопасности

Этот документ описывает **конвейер непрерывной интеграции**, инструменты качества и практики
безопасности, используемые в проекте Phoebe CMS.

---

## Конвейер CI/CD (GitHub Actions)

Проект использует **GitHub Actions** через рабочий процесс `gradle-ci.yml`.

### Задачи рабочего процесса

1.  **Настройка (Setup)**
    - Устанавливает JDK (Temurin, Java 21).
    - Кэширует зависимости Gradle.

2.  **Сборка (Build)**
    - Запускает `./gradlew build` с профилем `ci`.
    - Spring использует `application-ci.yml` → H2 база данных в памяти (быстро и изолированно).

3.  **Тестирование (Test)**
    - Запускает unit- и интеграционные тесты с покрытием:
      ```bash
      ./gradlew test jacocoTestReport
      ```
    - Загружает **отчеты тестов JUnit** как артефакты.
    - Загружает **отчеты покрытия JaCoCo** в Codecov.

4.  **Безопасность (Security)**
    - Запускает **GitLeaks** для обнаружения утечек секретов в кодовой базе.
    - Загружает отчет в случае провала сканирования.

5.  **Статический анализ: Checkstyle и PMD**
    - **Checkstyle** — обеспечивает соблюдение стиля кода Java и правил форматирования.
    - **PMD** — обнаруживает распространенные недостатки программирования и неиспользуемый код.
    - Оба инструмента автоматически выполняются в задаче Gradle `check`.

---

## Инструменты, интегрированные в CI

- **JaCoCo** — покрытие тестами (артефакт + отчет в Codecov).
- **Codecov** — метрики покрытия, интегрированные в Pull Requests.
- **Checkstyle** — обеспечение единого стиля кода.
- **PMD** — статический анализ для выявления проблемных мест в коде.
- **GitLeaks** — сканирование на наличие секретов для предотвращения случайных утечек.
- **Bucket4j** — зависимость для ограничения частоты запросов для защиты API.

---

## Лучшие практики безопасности

1.  **Архитектура аутентификации**
    - **Basic Auth** с учетными данными из окружения (без хранения в БД).
    - **Двухролевая система**: ADMIN (полный доступ) и EDITOR (только свой контент).
    - **Кодирование паролей BCrypt** для безопасного хранения.
    - Детали реализации: см. [Руководство по безопасности ролей](./SECURITY_ROLES_RU.md).

2.  **Секреты в CI**
    - Используйте **секреты репозитория GitHub** (Settings → Secrets → Actions).
    - Примеры: `DEV_DB_URL`, `DEV_DB_USER`, `ADMIN_PASSWORD`.
    - Никогда не коммитьте файл `.env` с реальными секретами в репозиторий.

3.  **Профили для CI**
    - Всегда запускайте тесты в CI с профилем `ci` (использует H2 в памяти).
    - Это гарантирует, что сборки не зависят от внешних баз данных.

4.  **Docker и секреты при развертывании**
    - Локальная разработка → `.env` (игнорируется git).
    - CI → Секреты GitHub.
    - Продакшен (например, Render) → переменные окружения или файлы секретов.

5.  **GitLeaks**
    - Предотвращает случайную отправку учетных данных, API-ключей или токенов.
    - Запускайте локально перед коммитом:
      ```bash
      gitleaks detect --source .
      ```

---

## Итог

- Конвейер CI/CD **полностью автоматизирован**: сборка → тесты → качество → безопасность.
- Качество кода контролируется с помощью **Checkstyle**, **PMD**, **JaCoCo** и **Codecov**.
- Секреты строго управляются через переменные окружения/секреты.
- Сканирование безопасности (GitLeaks) защищает репозиторий от утечек секретов.
- **Ограничение частоты запросов** обеспечивает защиту API от злоупотреблений.

---