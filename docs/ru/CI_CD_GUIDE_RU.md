# Руководство по CI/CD и безопасности

Этот документ описывает **конвейер непрерывной интеграции**, инструменты качества и практики
безопасности, используемые в проекте Phoebe CMS.

> **Связанное**: [Реализация стратегии MySQL](./MYSQL_STRATEGY_IMPLEMENTATION_RU.md) - Подробности о подходе "продакшн-первый" и удалении H2.  
> **Связанное**: [Руководство по стратегии тестирования](./TESTING_STRATEGY_RU.md) - Полный обзор архитектуры тестирования, включая гибридный подход интеграционного тестирования.

---

## Конвейер CI/CD (GitHub Actions)

Проект использует **GitHub Actions** через рабочий процесс `gradle-ci.yml`.

### Задачи рабочего процесса

1.  **Настройка (Setup)**
    - Устанавливает JDK (Temurin, Java 21).
    - Кэширует зависимости Gradle.

2.  **Сборка (Build)**
    - Запускает `./gradlew build` с унифицированным подходом Testcontainers.
    - Все интеграционные тесты используют Testcontainers MySQL (идентично локальной разработке).

3.  **Тестирование (Test)**
    - Запускает unit- и интеграционные тесты с покрытием:
      ```bash
      ./gradlew test jacocoTestReport
      ```
    - Загружает **отчеты тестов JUnit** как артефакты.
    - Загружает **отчеты покрытия JaCoCo** в Codecov.

4.  **Безопасность (Security)**
    - Запускает **GitLeaks** для обнаружения утечек секретов в кодовой базе.
    - Загружает отчет в случае провала сканирования.

5.  **Статический анализ: Checkstyle и PMD**
    - **Checkstyle** — обеспечивает соблюдение стиля кода Java и правил форматирования.
    - **PMD** — обнаруживает распространенные недостатки программирования и неиспользуемый код.
    - Оба инструмента автоматически выполняются в задаче Gradle `check`.

---

## Инструменты, интегрированные в CI

- **JaCoCo** — покрытие тестами (артефакт + отчет в Codecov).
- **Codecov** — метрики покрытия, интегрированные в Pull Requests.
- **Checkstyle** — обеспечение единого стиля кода.
- **PMD** — статический анализ для выявления проблемных мест в коде.
- **GitLeaks** — сканирование на наличие секретов для предотвращения случайных утечек.
- **Bucket4j** — зависимость для ограничения частоты запросов для защиты API.

---

## Лучшие практики безопасности

1.  **Архитектура аутентификации**
    - **Basic Auth** с учетными данными из окружения (без хранения в БД).
    - **Двухролевая система**: ADMIN (полный доступ) и EDITOR (только свой контент).
    - **Кодирование паролей BCrypt** для безопасного хранения.
    - Детали реализации: см. [Руководство по безопасности ролей](./SECURITY_ROLES_RU.md).

2.  **Секреты в CI**
    - Используйте **секреты репозитория GitHub** (Settings → Secrets → Actions).
    - Примеры: `DEV_DB_URL`, `DEV_DB_USER`, `ADMIN_PASSWORD`.
    - Никогда не коммитьте файл `.env` с реальными секретами в репозиторий.

3.  **Профили для CI**
    - Тесты в CI используют профиль `integration-test` с Testcontainers MySQL.
    - Это гарантирует идентичные тестовые среды между локальной разработкой и CI.

6.  **Стратегия тестирования базы данных**
    - **Unit тесты**: Используют моки, без зависимостей от базы данных
    - **Интеграционные тесты**: Используют Testcontainers с MySQL (`BaseIntegrationTest`) везде
    - **Унифицированный подход**: Идентичные тестовые среды в локальной разработке и CI
    - **Профиль**: Единый профиль `integration-test` для всех интеграционных тестов
    - **Без Docker Compose**: CI больше не требует внешних сервисов базы данных

7.  **Стратегия базы данных**
    - **Подход "продакшн-первый"**: MySQL используется во всех средах
    - **Без зависимостей H2**: Исключена для обеспечения консистентности продакшена
    - **Унифицированное тестирование**: Testcontainers MySQL везде (локально и CI)
    - **Консистентность среды**: Идентичное поведение тестов на всех платформах
    - **Упрощенный CI**: Без внешних зависимостей базы данных или настройки Docker Compose

4.  **Docker и секреты при развертывании**
    - Локальная разработка → `.env` (игнорируется git).
    - CI → Секреты GitHub.
    - Продакшен (например, Render) → переменные окружения или файлы секретов.

5.  **GitLeaks**
    - Предотвращает случайную отправку учетных данных, API-ключей или токенов.
    - Запускайте локально перед коммитом:
      ```bash
      gitleaks detect --source .
      ```

---

## Итог

- Конвейер CI/CD **полностью автоматизирован**: сборка → тесты → качество → безопасность.
- Качество кода контролируется с помощью **Checkstyle**, **PMD**, **JaCoCo** и **Codecov**.
- Секреты строго управляются через переменные окружения/секреты.
- Сканирование безопасности (GitLeaks) защищает репозиторий от утечек секретов.
- **Ограничение частоты запросов** обеспечивает защиту API от злоупотреблений.

---