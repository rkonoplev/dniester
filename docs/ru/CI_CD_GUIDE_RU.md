# Руководство по CI/CD

Этот документ описывает конвейер непрерывной интеграции (CI), используемый в проекте.

> Для получения информации о локальном тестировании и разработке см. [Тестирование и разработка с Makefile](./TESTING_WITH_MAKEFILE_RU.md).

---

## Обзор конвейера (GitHub Actions)

Процесс CI/CD построен на **GitHub Actions** и определен в файле `.github/workflows/gradle-ci.yml`. Он запускается при каждом `push` или `pull request` в ветки `main`, `master` и `develop`.

### Основные этапы конвейера

1.  **Настройка окружения (Setup)**
    - Устанавливается **Java 21 (Temurin)**.
    - Включается **Docker**, необходимый для Testcontainers.

2.  **Сборка и Тестирование (Build and Test)**
    - Выполняется единая команда, которая собирает проект и запускает все виды тестов (юнит- и интеграционные):
      ```bash
      ./gradlew clean build integrationTest jacocoTestReport --no-daemon
      ```
    - **`clean`**: Очищает предыдущие артефакты сборки.
    - **`build`**: Компилирует код и запускает юнит-тесты (через зависимость от задачи `test`).
    - **`integrationTest`**: Запускает интеграционные тесты с использованием **Testcontainers**, которые поднимают временный экземпляр MySQL в Docker.
    - **`jacocoTestReport`**: Генерирует отчет о покрытии кода тестами.

3.  **Анализ покрытия (Code Coverage)**
    - При успешном завершении тестов отчет о покрытии, созданный JaCoCo, загружается в **Codecov**.
    - Это позволяет отслеживать динамику покрытия и анализировать ее непосредственно в Pull Request.

---

## Инструменты и Качество Кода

Качество кода обеспечивается на нескольких уровнях, интегрированных в сборку Gradle:

- **Testcontainers**: Гарантирует, что интеграционные тесты выполняются в окружении, идентичном продакшену (MySQL), как локально, так и в CI.
- **JaCoCo**: Измеряет покрытие кода тестами.
- **Codecov**: Предоставляет визуализацию отчетов о покрытии.
- **Checkstyle & PMD**: Инструменты статического анализа, которые следят за стилем кода и обнаруживают потенциальные проблемы. Они автоматически запускаются во время задачи `build`.

---

## Безопасность

- **Управление секретами**: В CI используются **GitHub Actions Secrets** для безопасного хранения учетных данных. Локально используется файл `.env`, который исключен из Git.
- **Сканирование на секреты**: Хотя GitLeaks больше не является частью автоматического CI-пайплайна, рекомендуется использовать его локально перед отправкой изменений, чтобы избежать случайной утечки ключей и паролей.
  ```bash
  gitleaks detect --source .
  ```

---

## Итог

- Конвейер CI полностью автоматизирован и унифицирован.
- Команда, выполняемая в CI, эквивалентна локальному запуску `make all-tests`.
- Testcontainers обеспечивает надежное и изолированное тестирование в окружении, приближенном к продакшену.
- Качество и безопасность кода контролируются на каждом этапе.