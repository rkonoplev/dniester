# Руководство по CI/CD и безопасности

Этот документ описывает **конвейер непрерывной интеграции**, инструменты качества и практики
безопасности, используемые в проекте Phoebe CMS.

> **Связанное**: [ADR: Реализация стратегии "MySQL-first"](./MYSQL_STRATEGY_IMPLEMENTATION_RU.md) - Подробности о подходе "продакшн-первый" и удалении H2.  
> **Связанное**: [ADR: Унификация тестирования с Testcontainers](./TESTCONTAINERS_EVOLUTION_RU.md) - Полный обзор архитектуры тестирования.  
> **Связанное**: [Тестирование и разработка с Makefile](./TESTING_WITH_MAKEFILE_RU.md) - Практическое руководство по запуску тестов.

---

## Обзор конвейера (GitHub Actions)

Процесс CI/CD построен на **GitHub Actions** и определен в файле `.github/workflows/gradle-ci.yml`. Он запускается при каждом `push` или `pull request` в ветки `main`, `master` и `develop`.

### Основные этапы конвейера

1.  **Настройка окружения (Setup Environment)**
    - Устанавливается **Java 21 (Temurin)**.
    - Включается **Docker** (стандартный демон GitHub Actions), необходимый для Testcontainers.

2.  **Сборка и Тестирование (Build and Test)**
    - Выполняется единая команда, которая собирает проект и запускает все виды тестов (юнит- и интеграционные):
      ```bash
      ./gradlew clean build integrationTest jacocoTestReport --no-daemon
      ```
    - **`clean`**: Очищает предыдущие артефакты сборки.
    - **`build`**: Компилирует код и запускает юнит-тесты (через зависимость от задачи `test`).
    - **`integrationTest`**: Запускает интеграционные тесты с использованием **Testcontainers**, которые поднимают временный экземпляр MySQL в Docker.
    - **`jacocoTestReport`**: Генерирует отчет о покрытии кода тестами.
    - **`--no-daemon`**: Этот флаг используется для предотвращения запуска Gradle Daemon. В CI-средах это обеспечивает более предсказуемое и чистое выполнение, так как каждый запуск начинается с нуля, без влияния предыдущих состояний демона.

3.  **Анализ покрытия (Code Coverage)**
    - При успешном завершении тестов отчет о покрытии, созданный JaCoCo, загружается в **Codecov**.
    - Это позволяет отслеживать динамику покрытия и анализировать ее непосредственно в Pull Request.

---

## Инструменты, интегрированные в CI

- **Testcontainers**: Гарантирует, что интеграционные тесты выполняются в окружении, идентичном продакшену (MySQL), как локально, так и в CI.
- **JaCoCo**: Измеряет покрытие кода тестами.
- **Codecov**: Предоставляет визуализацию отчетов о покрытии.
- **Checkstyle & PMD**: Инструменты статического анализа, которые следят за стилем кода и обнаруживают потенциальные проблемы. Они автоматически запускаются во время задачи `build`.

---

## Лучшие практики безопасности

1.  **Архитектура аутентификации**
    - **Basic Auth** с учетными данными, хранящимися в базе данных (хешированные пароли).
    - **Двухролевая система**: ADMIN (полный доступ) и EDITOR (только свой контент).
    - **Кодирование паролей BCrypt** для безопасного хранения.
    - Детали реализации: см. [Руководство по безопасности ролей](./SECURITY_ROLES_RU.md).

2.  **Секреты в CI**
    - Используйте **секреты репозитория GitHub** (Settings → Secrets → Actions).
    - Примеры: `DEV_DB_URL`, `DEV_DB_USER`, `ADMIN_PASSWORD`.
    - Никогда не коммитьте файл `.env` с реальными секретами в репозиторий.

3.  **Профили для CI**
    - Тесты в CI используют профиль `integration-test` с Testcontainers MySQL.
    - Это гарантирует идентичные тестовые среды между локальной разработкой и CI.

4.  **Docker и секреты при развертывании**
    - Локальная разработка → `.env` (игнорируется git).
    - CI → Секреты GitHub.
    - Продакшен (например, Render) → переменные окружения или файлы секретов.

5.  **Сканирование на секреты (GitLeaks)**
    - GitLeaks больше не является частью автоматического CI-пайплайна, чтобы оптимизировать время выполнения и избежать ложных срабатываний. Вместо этого рекомендуется использовать его локально перед отправкой изменений, чтобы избежать случайной утечки ключей и паролей.
      ```bash
      gitleaks detect --source .
      ```

6.  **Ограничение частоты запросов (Rate Limiting)**
    - Реализовано с помощью библиотеки **Bucket4j** для защиты API от злоупотреблений.
    - Подробности: см. [Руководство по ограничению частоты запросов](./RATE_LIMITING_RU.md).

---

## Устранение неполадок в CI

### Проблема: `ConnectException` или `Communications link failure` при подключении к базе данных в тестах

**Описание**: Интеграционные тесты, использующие Testcontainers, могут завершаться с ошибками типа `java.net.ConnectException` или `Communications link failure` при попытке подключения к базе данных MySQL. Это происходит, если Docker-демон не успевает полностью инициализироваться до того, как Testcontainers попытается запустить контейнер или Spring Boot приложение попытается к нему подключиться.

**Решение**: Добавление небольшой задержки после запуска Docker-демона в файле `.github/workflows/gradle-ci.yml` позволяет Docker полностью подготовиться.

**Пример изменения в `gradle-ci.yml`**:
```yaml
      - name: Enable Docker
        run: sudo service docker start
      - name: Wait for Docker to be fully ready
        run: |
          echo "Waiting for Docker..."
          sleep 10s # Даем Docker 10 секунд на полную инициализацию
          docker info # Проверяем статус Docker
          docker ps -a # Показываем все контейнеры (если есть)
```
Эта задержка в 10 секунд дает Docker достаточно времени для инициализации всех своих компонентов, повышая стабильность запуска Testcontainers.

---

## Итог

- Конвейер CI/CD **полностью автоматизирован**: сборка → тесты → качество → безопасность.
- Качество кода контролируется с помощью **Checkstyle**, **PMD**, **JaCoCo** и **Codecov**.
- Секреты строго управляются через переменные окружения/секреты.
- Сканирование безопасности (GitLeaks) защищает репозиторий от утечек секретов.
- **Ограничение частоты запросов** обеспечивает защиту API от злоупотреблений.
