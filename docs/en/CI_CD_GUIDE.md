# CI/CD and Security Guide

This document describes the **continuous integration pipeline**, quality tools, and security practices
used in the Phoebe CMS project.

> **Related**: [ADR: MySQL-first Strategy Implementation](./MYSQL_STRATEGY_IMPLEMENTATION.md) - Details about the production-first database approach and H2 removal.  
> **Related**: [ADR: Unifying the Testing Strategy with Testcontainers](./TESTCONTAINERS_EVOLUTION.md) - Complete testing architecture overview.  
> **Related**: [Testing and Development with Makefile](./TESTING_WITH_MAKEFILE.md) - Practical guide for running tests.

---

## CI/CD Pipeline Overview (GitHub Actions)

The CI/CD process is built on **GitHub Actions** and defined in the `.github/workflows/gradle-ci.yml` file. It runs on every `push` or `pull request` to the `main`, `master`, and `develop` branches.

### Main Pipeline Stages

1.  **Setup Environment**
    - Installs **Java 21 (Temurin)**.
    - Enables **Docker** (standard GitHub Actions daemon), which is required for Testcontainers.

2.  **Build and Test**
    - A single command is executed to build the project and run all types of tests (unit and integration):
      ```bash
      ./gradlew clean build integrationTest jacocoTestReport --no-daemon
      ```
    - **`clean`**: Cleans up previous build artifacts.
    - **`build`**: Compiles the code and runs unit tests (via the `test` task dependency).
    - **`integrationTest`**: Runs integration tests using **Testcontainers**, which spins up a temporary MySQL instance in Docker.
    - **`jacocoTestReport`**: Generates a code coverage report.
    - **`--no-daemon`**: This flag is used to prevent the Gradle Daemon from running. In CI environments, this ensures a more predictable and clean execution, as each run starts from scratch without the influence of previous daemon states.

3.  **Code Coverage Analysis**
    - On successful test completion, the coverage report generated by JaCoCo, is uploaded to **Codecov**.
    - This allows tracking coverage trends and analyzing them directly in Pull Requests.

---

## Tools Integrated in CI

- **Testcontainers**: Ensures that integration tests run in a production-like environment (MySQL), both locally and in CI.
- **JaCoCo**: Measures code coverage by tests.
- **Codecov**: Provides visualization for coverage reports.
- **Checkstyle & PMD**: Static analysis tools that enforce code style and detect potential issues. They are automatically run during the `build` task.

---

## Security Best Practices

1.  **Authentication Architecture**
    - **Basic Auth** with credentials stored in the database (hashed passwords).
    - **Two-role system**: ADMIN (full access) and EDITOR (own content only).
    - **BCrypt password encoding** for secure credential storage.
    - Implementation details: See [Role Security Implementation Guide](./SECURITY_ROLES.md).

2.  **Secrets in CI**
    - Use GitHub **Repository Secrets** (Settings → Secrets → Actions).
    - Examples: `DEV_DB_URL`, `DEV_DB_USER`, `ADMIN_PASSWORD`.
    - Never commit `.env` with real secrets into repo.

3.  **Profiles for CI**
    - CI tests use `integration-test` profile with Testcontainers MySQL.
    - Ensures identical test environments between local development and CI.

4.  **Docker & Deploy Secrets**
    - Local dev → `.env` (ignored by git).
    - CI → GitHub Secrets.
    - Production (e.g., Render) → environment variables or Secret Files.

5.  **Secret Scanning (GitLeaks)**
    - GitLeaks is no longer part of the automated CI pipeline to optimize execution time and avoid false positives. Instead, it is recommended to use it locally before pushing changes to prevent accidental leaks of keys and passwords.
      ```bash
      gitleaks detect --source .
      ```

6.  **Rate Limiting**
    - Implemented using the **Bucket4j** library to protect the API from abuse.
    - Details: See [Rate Limiting Implementation](./RATE_LIMITING.md).

---

## Troubleshooting in CI

### Problem: `ConnectException` or `Communications link failure` when connecting to the database in tests

**Description**: Integration tests using Testcontainers might fail with errors like `java.net.ConnectException` or `Communications link failure` when attempting to connect to the MySQL database. This occurs if the Docker daemon is not fully initialized before Testcontainers tries to start a container or the Spring Boot application tries to connect to it.

**Solution**: Adding a small delay after starting the Docker daemon in the `.github/workflows/gradle-ci.yml` file allows Docker to fully prepare.

**Example change in `gradle-ci.yml`**:
```yaml
      - name: Enable Docker
        run: sudo service docker start
      - name: Wait for Docker to be fully ready
        run: |
          echo "Waiting for Docker..."
          sleep 10s # Give Docker 10 seconds to fully initialize
          docker info # Check Docker status
          docker ps -a # Show all containers (if any)
```
This 10-second delay provides Docker with sufficient time to initialize all its components, increasing the stability of Testcontainers launches.

---

## Summary

- The CI/CD pipeline is **fully automated**: build → test → quality → security.
- Code quality is controlled with **Checkstyle**, **PMD**, **JaCoCo**, and **Codecov**.
- Secrets are strictly managed through environment variables/secrets.
- Security scanning (GitLeaks) protects the repository against secret leaks.
- **Rate limiting** provides API protection against abuse.
