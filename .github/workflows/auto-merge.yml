name: Auto Merge PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Check PR target branch
        if: github.event.pull_request.base.ref != 'main'
        run: |
          echo "PR target branch is not 'main'. Skipping auto-merge."
          exit 0

      - name: Auto-merge if all checks pass
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber;
            if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'check_suite') {
              const { data: prs } = await github.rest.search.issuesAndPullRequests({
                q: `repo:${context.repo.owner}/${context.repo.repo} is:pr is:open sha:${context.payload.check_suite.head_sha}`
              });
              if (prs.items.length > 0) {
                prNumber = prs.items[0].number;
              }
            }

            if (!prNumber) {
              console.log("No open PR found for this commit. Skipping.");
              return;
            }

            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.check_suite?.head_sha || context.payload.pull_request?.head.sha
            });

            const allChecksPassed = checks.check_runs.every(check =>
              check.status === 'completed' && check.conclusion === 'success'
            );

            if (!allChecksPassed) {
              console.log("Not all checks passed. Skipping auto-merge.");
              return;
            }

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'squash'
            });

            console.log(`PR #${prNumber} merged successfully.`);
